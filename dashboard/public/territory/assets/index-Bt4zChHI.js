import{r as c,a as Ke,N as Ge,u as ye,L as Ne,b as Fe,B as Qe,R as es,c as ue,d as ss}from"./vendor-ycPT9Mzr.js";import{a as ze,l as Be}from"./api-Bs1G8lkK.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))r(l);new MutationObserver(l=>{for(const i of l)if(i.type==="childList")for(const f of i.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&r(f)}).observe(document,{childList:!0,subtree:!0});function a(l){const i={};return l.integrity&&(i.integrity=l.integrity),l.referrerPolicy&&(i.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?i.credentials="include":l.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(l){if(l.ep)return;l.ep=!0;const i=a(l);fetch(l.href,i)}})();var Oe={exports:{}},be={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ts=c,rs=Symbol.for("react.element"),as=Symbol.for("react.fragment"),ns=Object.prototype.hasOwnProperty,os=ts.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,is={key:!0,ref:!0,__self:!0,__source:!0};function Ue(s,t,a){var r,l={},i=null,f=null;a!==void 0&&(i=""+a),t.key!==void 0&&(i=""+t.key),t.ref!==void 0&&(f=t.ref);for(r in t)ns.call(t,r)&&!is.hasOwnProperty(r)&&(l[r]=t[r]);if(s&&s.defaultProps)for(r in t=s.defaultProps,t)l[r]===void 0&&(l[r]=t[r]);return{$$typeof:rs,type:s,key:i,ref:f,props:l,_owner:os.current}}be.Fragment=as;be.jsx=Ue;be.jsxs=Ue;Oe.exports=be;var e=Oe.exports,Ee={},Re=Ke;Ee.createRoot=Re.createRoot,Ee.hydrateRoot=Re.hydrateRoot;const cs="/territory-api";let W=null,we=[];const O=ze.create({baseURL:cs,withCredentials:!0,timeout:3e4});O.interceptors.request.use(s=>{var t;return console.log("📤 API Request:",{url:s.url,method:(t=s.method)==null?void 0:t.toUpperCase(),hasToken:!!W,tokenStart:W?W.substring(0,20)+"...":"none",timestamp:new Date().toLocaleTimeString()}),W&&!s.url.includes("/auth/")&&(s.headers.Authorization=`Bearer ${W}`),s},s=>Promise.reject(s));let Ce=!1,Ie=[];const ls=s=>{Ie.push(s)},ds=s=>{Ie.forEach(t=>t(s)),Ie=[]};O.interceptors.response.use(s=>s,async s=>{var a,r,l,i;const t=s.config;if(console.log("🔍 API Error Interceptor:",{url:t.url,status:(a=s.response)==null?void 0:a.status,data:(r=s.response)==null?void 0:r.data,hasToken:!!W,isRetry:t._retry,timestamp:new Date().toLocaleTimeString()}),((l=s.response)==null?void 0:l.status)===401&&!t._retry&&!t.url.includes("/auth/")){if(console.log("🔄 Attempting token refresh..."),Ce)return console.log("⏳ Token refresh already in progress, queuing request..."),new Promise(f=>{ls(b=>{t.headers.Authorization=`Bearer ${b}`,f(O(t))})});t._retry=!0,Ce=!0;try{return console.log("🚀 Calling refresh endpoint..."),W=(await O.post("/auth/refresh")).data.accessToken,we.forEach(b=>b(W)),console.log("✅ Token refreshed successfully"),ds(W),t.headers.Authorization=`Bearer ${W}`,console.log("🔁 Retrying original request..."),O(t)}catch(f){return console.log("❌ Token refresh failed:",(i=f.response)==null?void 0:i.data),W=null,console.log("🚪 Redirecting to login..."),window.location.href="/login",Promise.reject(f)}finally{Ce=!1}}return Promise.reject(s)});const Te=s=>{W=s,we.forEach(t=>t(s))},ms=()=>{W=null,we.forEach(s=>s(null))},us=s=>{we.push(s)},je={signup:(s,t,a)=>O.post("/auth/signup",{email:s,username:t,password:a}),login:(s,t)=>O.post("/auth/login",{email:s,password:t}),logout:()=>O.post("/auth/logout"),refresh:()=>O.post("/auth/refresh")},xe={getGames:()=>O.get("/games"),createGame:(s,t,a=2)=>O.post("/games",{title:s,gameType:t,maxPlayers:a}),getGame:s=>O.get(`/games/${s}`),joinGame:s=>O.post(`/games/${s}/join`),addPlayer:(s,t)=>O.post(`/games/${s}/players`,{identifier:t}),makeMove:(s,t)=>O.post(`/games/${s}/moves`,{moveData:t}),updateGameState:(s,t,a,r)=>O.put(`/games/${s}/state`,{gameState:t,status:a,winnerId:r}),deleteGame:s=>O.delete(`/games/${s}`)},hs="/territory-api",Q=ze.create({baseURL:hs,withCredentials:!0,timeout:3e4,headers:{"Content-Type":"application/json"}});let te=null;us(s=>{te=s});Q.interceptors.request.use(s=>{var t;return console.log("🎯 Territory API Request:",{url:s.url,method:(t=s.method)==null?void 0:t.toUpperCase(),hasToken:!!te,tokenStart:te?te.substring(0,20)+"...":"none",timestamp:new Date().toLocaleTimeString()}),te&&(s.headers.Authorization=`Bearer ${te}`),s},s=>Promise.reject(s));Q.interceptors.response.use(s=>(console.log("✅ Territory API Response:",{url:s.config.url,status:s.status,timestamp:new Date().toLocaleTimeString()}),s),async s=>{var a,r,l,i,f;const t=s.config;if(console.log("❌ Territory API Error:",{url:(t==null?void 0:t.url)||"unknown",status:(a=s.response)==null?void 0:a.status,data:(r=s.response)==null?void 0:r.data,message:s.message,code:s.code,timestamp:new Date().toLocaleTimeString()}),s.code==="ECONNABORTED"||(l=s.message)!=null&&l.includes("timeout"))return console.log("⏱️ Request timed out after 30 seconds"),s.customMessage="Request timed out. The server may be experiencing high load.",Promise.reject(s);if(!s.response&&s.message==="Network Error")return console.log("🔌 Network error - cannot reach server"),s.customMessage="Cannot connect to server. Please check your connection.",Promise.reject(s);if((i=s.message)!=null&&i.includes("aborted"))return console.log("🚫 Request was aborted, not retrying"),Promise.reject(s);if(((f=s.response)==null?void 0:f.status)===401&&!t._retry){console.log("🔄 Territory API: Attempting token refresh..."),t._retry=!0;try{if(te=(await Q.post("/auth/refresh")).data.accessToken,console.log("✅ Territory API: Token refreshed"),te)return t.headers.Authorization=`Bearer ${te}`,Q(t)}catch(b){return console.log("❌ Territory API: Token refresh failed, redirecting to login"),window.location.href="/login",Promise.reject(b)}}return Promise.reject(s)});const J={setAuthToken:s=>{te=s},createGame:async s=>(await Q.post("/territory/create",{title:s})).data,joinGame:async s=>(await Q.post(`/territory/${s}/join`)).data,getRegion:async(s,t)=>{const a=new URLSearchParams({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY});return(await Q.get(`/territory/${s}/region?${a}`)).data},getAvailableMoves:async s=>(await Q.get(`/territory/${s}/moves`)).data,makeMove:async(s,t,a)=>(await Q.post(`/territory/${s}/move`,{x:t,y:a})).data,addPlayer:async(s,t)=>(await Q.post(`/territory/${s}/players`,{identifier:t})).data,getScoreboard:async s=>(await Q.get(`/territory/${s}/scoreboard`)).data},qe=c.createContext(),he=()=>{const s=c.useContext(qe);if(!s)throw new Error("useAuth must be used within AuthProvider");return s},ps=({children:s})=>{const[t,a]=c.useState(null),[r,l]=c.useState(!0);c.useEffect(()=>{i()},[]);const i=async()=>{try{const A=await je.refresh();a(A.data.user),Te(A.data.accessToken),J.setAuthToken(A.data.accessToken)}catch{console.log("Not authenticated")}finally{l(!1)}},j={user:t,loading:r,signup:async(A,D,S)=>{const v=await je.signup(A,D,S);return a(v.data.user),Te(v.data.accessToken),J.setAuthToken(v.data.accessToken),v.data},login:async(A,D)=>{const S=await je.login(A,D);return a(S.data.user),Te(S.data.accessToken),J.setAuthToken(S.data.accessToken),S.data},logout:async()=>{try{await je.logout()}catch(A){console.error("Logout error:",A)}finally{a(null),ms(),J.setAuthToken(null)}}};return e.jsx(qe.Provider,{value:j,children:s})},Ye=c.createContext(),Me=()=>{const s=c.useContext(Ye);if(!s)throw new Error("useTheme must be used within a ThemeProvider");return s},gs=({children:s})=>{const[t,a]=c.useState(()=>localStorage.getItem("game-theme")||"dark");c.useEffect(()=>{localStorage.setItem("game-theme",t),document.documentElement.setAttribute("data-theme",t)},[t]);const l={theme:t,toggleTheme:()=>{a(i=>i==="dark"?"light":"dark")},isDark:t==="dark",isLight:t==="light"};return e.jsx(Ye.Provider,{value:l,children:s})},Ae=({children:s})=>{const{user:t,loading:a}=he();return a?e.jsx("div",{className:"loading",children:"Loading..."}):t?s:e.jsx(Ge,{to:"/login",replace:!0})},xs=()=>{const[s,t]=c.useState(""),[a,r]=c.useState(""),[l,i]=c.useState(!1),[f,b]=c.useState(""),[w,j]=c.useState(""),[A,D]=c.useState([]),[S,v]=c.useState(null),{login:G}=he(),F=ye(),E=(g,h="info")=>{const N=new Date().toLocaleTimeString();D(k=>[...k.slice(-9),{timestamp:N,message:g,type:h}])},U=async()=>{j("Testing API connection..."),E("Starting API health check","info");try{const g="/territory-api/health";j(`Testing: ${g}`),E(`Testing URL: ${g}`,"info");const h=performance.now(),N=await fetch(g,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)}),k=Math.round(performance.now()-h);if(E(`Response time: ${k}ms`,"success"),E(`Status: ${N.status} ${N.statusText}`,N.ok?"success":"error"),!N.ok)throw new Error(`HTTP ${N.status}: ${N.statusText}`);const C=await N.json();j(`✅ API OK | URL: ${g} | Response: ${JSON.stringify(C)}`),E(`API Response: ${JSON.stringify(C)}`,"success")}catch(g){E(`Error: ${g.message}`,"error"),g.name==="TimeoutError"||g.message.includes("timeout")?j("❌ TIMEOUT | URL might be wrong or server down | Tried: /territory-api"):g.name==="TypeError"&&g.message.includes("fetch")?(j("❌ NETWORK ERROR | Can't reach server | Check if territory backend is running"),E("Network error - server unreachable","error")):j(`❌ API FAILED | Error: ${g.message} | Type: ${g.name}`)}},Y=g=>{g==="alice"?(t("alice@example.com"),r("password123")):(t("bob@example.com"),r("password456")),j("Test credentials filled")},_=async g=>{var h,N,k,C,Z,ee,p,y,z,d,I;g.preventDefault(),i(!0),b(""),j("Starting login..."),E(`Login attempt for: ${s}`,"info"),v(null);try{E("Login URL: /territory-api/auth/login","info"),j("Calling API...");const M=performance.now();await G(s,a);const R=Math.round(performance.now()-M);E(`Login successful in ${R}ms`,"success"),j("Login successful, redirecting..."),F("/dashboard")}catch(T){const M=((N=(h=T.response)==null?void 0:h.config)==null?void 0:N.responseTime)||"unknown",R=((C=(k=T.response)==null?void 0:k.data)==null?void 0:C.error)||T.message||"Login failed",B=((Z=T.response)==null?void 0:Z.status)||"Unknown",se=((ee=T.response)==null?void 0:ee.statusText)||"No status text",ie="/territory-api",re=((y=(p=T.response)==null?void 0:p.config)==null?void 0:y.url)||"Unknown URL";b(R),v({message:R,status:B,statusText:se,url:re,responseTime:M,details:((z=T.response)==null?void 0:z.data)||{},timestamp:new Date().toISOString()}),E(`Login failed: ${R}`,"error"),E(`Status: ${B} ${se}`,"error"),E(`Response time: ${M}`,"error"),(d=T.response)!=null&&d.data&&E(`Server response: ${JSON.stringify(T.response.data)}`,"error"),j(`❌ LOGIN FAILED | Error: ${R} | Status: ${B} | API: ${ie}`),console.error("Login error details:",{error:T,response:T.response,message:T.message,stack:T.stack,config:(I=T.response)==null?void 0:I.config})}finally{i(!1)}};return e.jsxs("div",{className:"territory-auth-container",children:[e.jsx("div",{className:"territory-grid-bg"}),e.jsx("div",{className:"territory-auth-overlay",children:e.jsxs("div",{className:"territory-auth-form",children:[e.jsxs("div",{className:"territory-logo-section",children:[e.jsx("div",{className:"territory-logo",children:e.jsxs("div",{className:"logo-grid",children:[e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"})]})}),e.jsx("h1",{children:"Territory Conquest"}),e.jsx("p",{className:"territory-tagline",children:"Claim your domain. Expand your empire."})]}),f&&e.jsx("div",{className:"territory-error",children:f}),w&&e.jsx("div",{className:"territory-debug-info",children:w}),e.jsxs("div",{className:"territory-connection-info",children:[e.jsxs("small",{children:[e.jsx("strong",{children:"API:"})," ","/territory-api"," (Production)"]}),e.jsx("br",{}),e.jsxs("small",{children:[e.jsx("strong",{children:"Host:"})," ",typeof window<"u"?window.location.host:"N/A"]}),e.jsx("br",{}),e.jsxs("small",{children:[e.jsx("strong",{children:"Protocol:"})," ",typeof window<"u"?window.location.protocol:"N/A"]}),e.jsx("br",{}),e.jsxs("small",{children:[e.jsx("strong",{children:"User Agent:"})," ",typeof navigator<"u"?navigator.userAgent.substring(0,50)+"...":"N/A"]})]}),e.jsxs("div",{className:"territory-test-section",children:[e.jsx("h3",{children:"Diagnostics & Quick Access"}),e.jsxs("div",{className:"territory-test-buttons",children:[e.jsx("button",{type:"button",className:"territory-btn-test api",onClick:U,children:"🔗 Test API"}),e.jsx("button",{type:"button",className:"territory-btn-test alice",onClick:()=>Y("alice"),children:"👤 Alice"}),e.jsx("button",{type:"button",className:"territory-btn-test bob",onClick:()=>Y("bob"),children:"👤 Bob"})]}),e.jsxs("div",{className:"territory-test-buttons",children:[e.jsx("button",{type:"button",className:"territory-btn-test direct",onClick:()=>window.open(`${window.location.origin}/territory-api/health`,"_blank"),children:"🚀 Direct API Test"}),e.jsx("button",{type:"button",className:"territory-btn-test clear",onClick:()=>{D([]),v(null),j("")},children:"🗑️ Clear Logs"})]}),A.length>0&&e.jsxs("div",{className:"territory-diagnostics-log",children:[e.jsx("h4",{children:"Network Activity Log"}),e.jsx("div",{className:"diagnostics-entries",children:A.map((g,h)=>e.jsxs("div",{className:`diagnostic-entry ${g.type}`,children:[e.jsx("span",{className:"diagnostic-time",children:g.timestamp}),e.jsx("span",{className:"diagnostic-message",children:g.message})]},h))})]}),S&&e.jsxs("div",{className:"territory-error-details",children:[e.jsx("h4",{children:"Last Error Details"}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Message:"})," ",S.message]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Status:"})," ",S.status," ",S.statusText]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"URL:"})," ",S.url]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Time:"})," ",new Date(S.timestamp).toLocaleString()]}),Object.keys(S.details).length>0&&e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Response:"}),e.jsx("pre",{children:JSON.stringify(S.details,null,2)})]})]})]}),e.jsxs("form",{onSubmit:_,className:"territory-form",children:[e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"email",placeholder:"Email Address",value:s,onChange:g=>t(g.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"password",placeholder:"Password",value:a,onChange:g=>r(g.target.value),required:!0,className:"territory-input"})}),e.jsxs("button",{type:"submit",disabled:l,className:"territory-login-btn",children:[e.jsx("span",{className:"btn-grid-effect"}),l?"⚡ Connecting...":"🏁 Enter Battle"]})]}),e.jsx("div",{className:"territory-signup-link",children:e.jsxs("p",{children:["New commander? ",e.jsx(Ne,{to:"/signup",className:"territory-link",children:"Join the conquest"})]})})]})})]})},fs=()=>{const[s,t]=c.useState(""),[a,r]=c.useState(""),[l,i]=c.useState(""),[f,b]=c.useState(!1),[w,j]=c.useState(""),{signup:A}=he(),D=ye(),S=async v=>{var G,F;v.preventDefault(),b(!0),j("");try{await A(s,a,l),D("/dashboard")}catch(E){j(((F=(G=E.response)==null?void 0:G.data)==null?void 0:F.error)||"Signup failed")}finally{b(!1)}};return e.jsxs("div",{className:"territory-auth-container",children:[e.jsx("div",{className:"territory-grid-bg"}),e.jsx("div",{className:"territory-auth-overlay",children:e.jsxs("div",{className:"territory-auth-form",children:[e.jsxs("div",{className:"territory-logo-section",children:[e.jsx("div",{className:"territory-logo",children:e.jsxs("div",{className:"logo-grid",children:[e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"})]})}),e.jsx("h1",{children:"Join the Conquest"}),e.jsx("p",{className:"territory-tagline",children:"Establish your command. Build your empire."})]}),w&&e.jsx("div",{className:"territory-error",children:w}),e.jsxs("form",{onSubmit:S,className:"territory-form",children:[e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"email",placeholder:"Email Address",value:s,onChange:v=>t(v.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"text",placeholder:"Commander Username",value:a,onChange:v=>r(v.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"password",placeholder:"Password (minimum 6 characters)",value:l,onChange:v=>i(v.target.value),required:!0,minLength:6,className:"territory-input"})}),e.jsxs("button",{type:"submit",disabled:f,className:"territory-login-btn",children:[e.jsx("span",{className:"btn-grid-effect"}),f?"⚡ Establishing Command...":"🚀 Begin Conquest"]})]}),e.jsx("div",{className:"territory-signup-link",children:e.jsxs("p",{children:["Already a commander? ",e.jsx(Ne,{to:"/login",className:"territory-link",children:"Enter the battle"})]})})]})})]})},ys=()=>{var z;const[s,t]=c.useState([]),[a,r]=c.useState(!0),[l,i]=c.useState(!1),[f,b]=c.useState(!1),[w,j]=c.useState({title:"",gameType:"territory",maxPlayers:8}),[A,D]=c.useState(null),[S,v]=c.useState(""),[G,F]=c.useState(!1),[E,U]=c.useState(null),[Y,_]=c.useState(!1),{user:g,logout:h}=he(),N=ye();c.useEffect(()=>{k()},[]);const k=async()=>{var d;try{const I=await xe.getGames();t(I.data)}catch(I){console.error("Failed to load games:",I),(d=I.response)==null||d.status}finally{r(!1)}},C=async d=>{var I,T;d.preventDefault(),i(!0);try{const M=await J.createGame(w.title);N(`/territory/${M.id}`),b(!1),j({title:"",gameType:"territory",maxPlayers:8})}catch(M){console.error("Failed to create game:",M),alert(`Failed to create game: ${((T=(I=M.response)==null?void 0:I.data)==null?void 0:T.error)||M.message}`)}finally{i(!1)}},Z=async(d,I)=>{var T,M;F(!0);try{await J.addPlayer(d,I),await k(),D(null),v("")}catch(R){console.error("Failed to add player:",R),alert(((M=(T=R.response)==null?void 0:T.data)==null?void 0:M.error)||"Failed to add player")}finally{F(!1)}},ee=async d=>{var I,T;_(!0);try{await xe.deleteGame(d),await k(),U(null)}catch(M){console.error("Failed to delete game:",M),alert(((T=(I=M.response)==null?void 0:I.data)==null?void 0:T.error)||"Failed to delete game")}finally{_(!1)}},p=d=>{var I;switch(d.status){case"WAITING":return`Waiting for players (${(I=d.players)==null?void 0:I.length}/${d.maxPlayers})`;case"ACTIVE":return"In progress";case"FINISHED":return"Finished";case"ABANDONED":return"Abandoned";default:return d.status}},y=d=>{switch(d){case"WAITING":return"status-waiting";case"ACTIVE":return"status-active";case"FINISHED":return"status-finished";case"ABANDONED":return"status-abandoned";default:return""}};return a?e.jsx("div",{className:"loading",children:"Loading games..."}):e.jsxs("div",{className:"territory-dashboard",children:[e.jsx("div",{className:"dashboard-bg-grid"}),e.jsxs("div",{className:"dashboard-overlay",children:[e.jsxs("header",{className:"territory-dashboard-header",children:[e.jsxs("div",{className:"dashboard-title-section",children:[e.jsx("div",{className:"dashboard-logo",children:e.jsxs("div",{className:"dashboard-logo-grid",children:[e.jsx("div",{className:"logo-cell active player1"}),e.jsx("div",{className:"logo-cell active player2"}),e.jsx("div",{className:"logo-cell active player3"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player3"})]})}),e.jsxs("div",{className:"dashboard-title-text",children:[e.jsx("h1",{children:"Command Center"}),e.jsxs("p",{className:"welcome-commander",children:["Welcome back, Commander ",g==null?void 0:g.username,"!"]}),e.jsxs("div",{className:"status-indicator",children:[e.jsx("span",{className:"status-dot online"}),e.jsx("span",{className:"status-text",children:"Systems Online"})]})]})]}),e.jsxs("div",{className:"dashboard-actions",children:[e.jsxs("button",{onClick:()=>b(!0),className:"territory-btn-primary",children:[e.jsx("span",{className:"btn-icon",children:"⚔️"}),e.jsx("span",{children:"New Campaign"})]}),e.jsxs("button",{onClick:h,className:"territory-btn-logout",children:[e.jsx("span",{className:"btn-icon",children:"🚪"}),e.jsx("span",{children:"Logout"})]})]})]}),f&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"🗺️ Launch New Campaign"}),e.jsx("div",{className:"modal-subtitle",children:"Establish your territory and expand your dominion"})]}),e.jsxs("form",{onSubmit:C,className:"territory-create-form",children:[e.jsxs("div",{className:"territory-form-group",children:[e.jsxs("label",{className:"territory-label",children:[e.jsx("span",{className:"label-icon",children:"📝"}),e.jsx("span",{children:"Campaign Name"})]}),e.jsx("input",{type:"text",placeholder:"Enter campaign name...",value:w.title,onChange:d=>j({...w,title:d.target.value}),required:!0,className:"territory-input"})]}),e.jsxs("div",{className:"campaign-info",children:[e.jsxs("div",{className:"info-header",children:[e.jsx("span",{className:"info-icon",children:"⚔️"}),e.jsx("span",{className:"info-title",children:"Territory Conquest"})]}),e.jsxs("div",{className:"info-features",children:[e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"🏰"}),e.jsx("span",{children:"Real-time strategy gameplay"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"🎯"}),e.jsx("span",{children:"Enclosed area capture mechanics"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"👥"}),e.jsx("span",{children:"Up to 8 commanders"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"⚡"}),e.jsx("span",{children:"Move regeneration system"})]})]})]}),e.jsxs("div",{className:"territory-form-actions",children:[e.jsxs("button",{type:"button",onClick:()=>b(!1),className:"territory-btn-cancel",children:[e.jsx("span",{className:"btn-icon",children:"❌"}),e.jsx("span",{children:"Cancel"})]}),e.jsxs("button",{type:"submit",disabled:l,className:"territory-btn-create",children:[e.jsx("span",{className:"btn-icon",children:l?"⏳":"🚀"}),e.jsx("span",{children:l?"Launching...":"Launch Campaign"})]})]})]})]})}),e.jsxs("div",{className:"territory-games-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"🏰 Active Campaigns"}),e.jsxs("div",{className:"section-stats",children:[e.jsxs("span",{className:"stat-item",children:[e.jsx("span",{className:"stat-icon",children:"📊"}),e.jsxs("span",{className:"stat-text",children:[s.length," Total"]})]}),e.jsxs("span",{className:"stat-item",children:[e.jsx("span",{className:"stat-icon",children:"⚡"}),e.jsxs("span",{className:"stat-text",children:[s.filter(d=>d.status==="ACTIVE").length," Active"]})]})]})]}),s.length===0?e.jsxs("div",{className:"territory-empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:e.jsxs("div",{className:"empty-grid",children:[e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell center",children:"?"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"})]})}),e.jsx("h3",{children:"No Campaigns Found"}),e.jsx("p",{children:"Begin your conquest by creating your first territory campaign!"}),e.jsxs("button",{onClick:()=>b(!0),className:"territory-btn-primary",children:[e.jsx("span",{className:"btn-icon",children:"⚔️"}),e.jsx("span",{children:"Start First Campaign"})]})]}):e.jsx("div",{className:"territory-games-grid",children:s.map(d=>{var I,T,M;return e.jsxs("div",{className:"territory-game-card",children:[e.jsxs("div",{className:"game-card-header",children:[e.jsxs("div",{className:"game-title-section",children:[e.jsx("h3",{children:d.title}),e.jsxs("div",{className:"game-type-badge",children:[e.jsx("span",{className:"badge-icon",children:"🗺️"}),e.jsx("span",{children:"Territory"})]})]}),e.jsxs("div",{className:`territory-status ${y(d.status)}`,children:[e.jsx("span",{className:"status-icon",children:js(d.status)}),e.jsx("span",{className:"status-label",children:p(d)})]})]}),e.jsxs("div",{className:"game-preview",children:[e.jsx("div",{className:"preview-grid",children:Array.from({length:25},(R,B)=>e.jsx("div",{className:`preview-cell ${d.players&&d.players.length>0?B%3===0?"occupied p1":B%5===0?"occupied p2":"":""}`},B))}),e.jsx("div",{className:"preview-overlay",children:e.jsx("span",{className:"preview-text",children:"Campaign Preview"})})]}),e.jsxs("div",{className:"game-info",children:[e.jsxs("div",{className:"commander-info",children:[e.jsx("span",{className:"commander-label",children:"Commander:"}),e.jsx("span",{className:"commander-name",children:d.owner.username})]}),e.jsxs("div",{className:"players-roster",children:[e.jsx("span",{className:"roster-label",children:"Forces:"}),e.jsxs("div",{className:"player-indicators",children:[(I=d.players)==null?void 0:I.slice(0,3).map((R,B)=>e.jsx("div",{className:`player-badge p${B+1}`,children:R.user.username.charAt(0).toUpperCase()},R.id)),d.players&&d.players.length>3&&e.jsxs("div",{className:"player-badge more",children:["+",d.players.length-3]}),!d.players||d.players.length===0&&e.jsx("div",{className:"no-players",children:"Awaiting reinforcements"})]})]})]}),e.jsxs("div",{className:"territory-game-actions",children:[e.jsxs(Ne,{to:`/${d.id}`,className:"territory-btn-play",children:[e.jsx("span",{className:"btn-icon",children:d.status==="FINISHED"?"👁️":"⚡"}),e.jsx("span",{children:d.status==="FINISHED"?"Inspect":"Deploy"})]}),d.ownerId===(g==null?void 0:g.id)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>D(d.id),className:"territory-btn-secondary",disabled:((T=d.players)==null?void 0:T.length)>=8,title:((M=d.players)==null?void 0:M.length)>=8?"Maximum 8 commanders":"Recruit commander",children:[e.jsx("span",{className:"btn-icon",children:"👥"}),e.jsx("span",{children:"Recruit"})]}),e.jsxs("button",{onClick:()=>U(d.id),className:"territory-btn-danger",title:"Abandon Campaign",children:[e.jsx("span",{className:"btn-icon",children:"💥"}),e.jsx("span",{children:"Abandon"})]})]})]})]},d.id)})})]})]}),A&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"👥 Recruit Commander"}),e.jsx("div",{className:"modal-subtitle",children:"Add a new commander to your campaign"})]}),e.jsxs("form",{onSubmit:d=>{d.preventDefault(),S.trim()&&Z(A,S.trim())},className:"territory-recruit-form",children:[e.jsxs("div",{className:"territory-form-group",children:[e.jsxs("label",{className:"territory-label",children:[e.jsx("span",{className:"label-icon",children:"🔍"}),e.jsx("span",{children:"Commander Identifier"})]}),e.jsx("input",{type:"text",placeholder:"Enter email or username...",value:S,onChange:d=>v(d.target.value),disabled:G,autoFocus:!0,className:"territory-input"})]}),e.jsx("div",{className:"recruit-info",children:e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-icon",children:"ℹ️"}),e.jsx("span",{children:"Commanders can immediately join and start conquering territory"})]})}),e.jsxs("div",{className:"territory-form-actions",children:[e.jsxs("button",{type:"button",onClick:()=>{D(null),v("")},className:"territory-btn-cancel",disabled:G,children:[e.jsx("span",{className:"btn-icon",children:"❌"}),e.jsx("span",{children:"Cancel"})]}),e.jsxs("button",{type:"submit",className:"territory-btn-create",disabled:!S.trim()||G,children:[e.jsx("span",{className:"btn-icon",children:G?"⏳":"👥"}),e.jsx("span",{children:G?"Recruiting...":"Recruit Commander"})]})]})]})]})}),E&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content danger",children:[e.jsxs("div",{className:"modal-header danger",children:[e.jsx("h2",{children:"💥 Abandon Campaign"}),e.jsx("div",{className:"modal-subtitle",children:"This action will permanently destroy the campaign"})]}),e.jsxs("div",{className:"danger-warning",children:[e.jsx("div",{className:"warning-icon",children:"⚠️"}),e.jsxs("div",{className:"warning-content",children:[e.jsx("p",{children:e.jsx("strong",{children:"This cannot be undone!"})}),e.jsx("p",{children:"All territory progress, commander data, and battle history will be lost."}),e.jsxs("div",{className:"campaign-details",children:[e.jsx("span",{className:"detail-label",children:"Campaign:"}),e.jsx("span",{className:"detail-value",children:(z=s.find(d=>d.id===E))==null?void 0:z.title})]})]})]}),e.jsxs("div",{className:"territory-form-actions danger",children:[e.jsxs("button",{type:"button",onClick:()=>U(null),className:"territory-btn-cancel",disabled:Y,children:[e.jsx("span",{className:"btn-icon",children:"🛡️"}),e.jsx("span",{children:"Keep Campaign"})]}),e.jsxs("button",{type:"button",onClick:()=>ee(E),className:"territory-btn-danger-confirm",disabled:Y,children:[e.jsx("span",{className:"btn-icon",children:Y?"⏳":"💥"}),e.jsx("span",{children:Y?"Abandoning...":"Abandon Campaign"})]})]})]})})]})},js=s=>{switch(s){case"WAITING":return"⏳";case"ACTIVE":return"⚡";case"FINISHED":return"🏆";case"ABANDONED":return"💀";default:return"❓"}},vs="/territory-ws";class Ns{constructor(){this.socket=null,this.gameId=null}connect(){return this.socket||(this.socket=Be(vs,{withCredentials:!0}),this.socket.on("connect",()=>{console.log("Connected to socket server")}),this.socket.on("disconnect",()=>{console.log("Disconnected from socket server")})),this.socket}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.gameId=null)}joinGame(t){this.socket&&t!==this.gameId&&(this.gameId&&this.socket.emit("leave-game",this.gameId),this.gameId=t,this.socket.emit("join-game",t))}leaveGame(){this.socket&&this.gameId&&(this.socket.emit("leave-game",this.gameId),this.gameId=null)}emitMove(t,a){this.socket&&this.socket.emit("game-move",{gameId:t,moveData:a})}emitStateChange(t,a,r,l){this.socket&&this.socket.emit("game-state-change",{gameId:t,gameState:a,status:r,winnerId:l})}onMoveMade(t){this.socket&&this.socket.on("move-made",t)}onStateUpdated(t){this.socket&&this.socket.on("state-updated",t)}offMoveMade(t){this.socket&&this.socket.off("move-made",t)}offStateUpdated(t){this.socket&&this.socket.off("state-updated",t)}}const ne=new Ns,bs=()=>{var F,E,U,Y,_,g;const{id:s}=Fe(),t=ye(),{user:a}=he(),[r,l]=c.useState(null),[i,f]=c.useState(!0),[b,w]=c.useState(""),j=c.useCallback(async()=>{var h,N,k;try{console.log("🎮 Loading game:",s,"for user:",a==null?void 0:a.username);const C=await xe.getGame(s);console.log("✅ Game loaded successfully:",C.data.title),l(C.data)}catch(C){console.error("❌ Failed to load game:",C),console.error("Error details:",{status:(h=C.response)==null?void 0:h.status,data:(N=C.response)==null?void 0:N.data,gameId:s,user:a==null?void 0:a.username}),((k=C.response)==null?void 0:k.status)===404&&(console.log("🚪 Game not found, redirecting to dashboard"),t("/dashboard"))}finally{f(!1)}},[s,t,a]);c.useEffect(()=>{j()},[j]),c.useEffect(()=>{if(r){ne.connect(),ne.joinGame(r.id);const h=k=>{console.log("Move made:",k),j()},N=k=>{console.log("State updated:",k),j()};return ne.onMoveMade(h),ne.onStateUpdated(N),()=>{ne.offMoveMade(h),ne.offStateUpdated(N),ne.leaveGame()}}},[r,j]);const A=async h=>{var N,k;if(h.preventDefault(),!!b.trim())try{const C={action:b.trim(),timestamp:Date.now()};await xe.makeMove(s,C),ne.emitMove(s,C),w(""),j()}catch(C){console.error("Failed to make move:",C),alert(((k=(N=C.response)==null?void 0:N.data)==null?void 0:k.error)||"Failed to make move")}},D=async()=>{var h,N;try{await xe.joinGame(s),j()}catch(k){console.error("Failed to join game:",k),alert(((N=(h=k.response)==null?void 0:h.data)==null?void 0:N.error)||"Failed to join game")}};if(i)return e.jsx("div",{className:"loading",children:"Loading game..."});if(!r)return e.jsx("div",{className:"error",children:"Game not found"});const S=(F=r.players)==null?void 0:F.some(h=>h.userId===(a==null?void 0:a.id));r.ownerId,a==null||a.id;const v=r.currentTurn===(a==null?void 0:a.id),G=(E=r.players)==null?void 0:E.find(h=>h.userId===r.currentTurn);return e.jsxs("div",{className:"game-room",children:[e.jsx("header",{className:"game-header",children:e.jsxs("div",{children:[e.jsx(Ne,{to:"/dashboard",className:"back-link",children:"← Back to Dashboard"}),e.jsx("h1",{children:r.title}),e.jsxs("div",{className:"game-meta",children:[e.jsx("span",{className:"game-type",children:r.gameType}),e.jsx("span",{className:`status status-${r.status.toLowerCase()}`,children:r.status})]})]})}),e.jsxs("div",{className:"game-content",children:[e.jsxs("div",{className:"game-sidebar",children:[e.jsxs("div",{className:"players-section",children:[e.jsxs("h3",{children:["Players (",(U=r.players)==null?void 0:U.length,"/",r.maxPlayers,")"]}),e.jsx("div",{className:"players-list",children:(Y=r.players)==null?void 0:Y.map(h=>e.jsxs("div",{className:`player ${h.userId===r.currentTurn?"current-turn":""}`,children:[e.jsx("span",{className:"player-name",children:h.user.username}),h.userId===r.ownerId&&e.jsx("span",{className:"owner-badge",children:"Owner"}),h.userId===r.currentTurn&&e.jsx("span",{className:"turn-indicator",children:"Current Turn"})]},h.id))}),!S&&r.status==="WAITING"&&e.jsx("button",{onClick:D,className:"btn-primary",children:"Join Game"})]}),r.moves&&r.moves.length>0&&e.jsxs("div",{className:"moves-section",children:[e.jsx("h3",{children:"Game Log"}),e.jsx("div",{className:"moves-list",children:r.moves.map(h=>{var N;return e.jsxs("div",{className:"move",children:[e.jsxs("span",{className:"move-player",children:[(N=h.user)==null?void 0:N.username,":"]}),e.jsx("span",{className:"move-data",children:typeof h.moveData=="string"?h.moveData:JSON.stringify(h.moveData)})]},h.id)})})]})]}),e.jsx("div",{className:"game-main",children:e.jsxs("div",{className:"game-board",children:[r.status==="WAITING"&&e.jsxs("div",{className:"waiting-message",children:[e.jsx("h2",{children:"Waiting for players..."}),e.jsx("p",{children:"Share this URL with friends to invite them to play!"})]}),r.status==="ACTIVE"&&e.jsxs("div",{className:"game-active",children:[e.jsx("div",{className:"turn-indicator",children:v?e.jsx("h3",{children:"Your turn!"}):e.jsxs("h3",{children:["Waiting for ",G==null?void 0:G.user.username,"'s move..."]})}),r.gameState&&e.jsxs("div",{className:"game-state",children:[e.jsx("h4",{children:"Game State:"}),e.jsx("pre",{children:typeof r.gameState=="string"?r.gameState:JSON.stringify(r.gameState,null,2)})]}),S&&v&&e.jsx("div",{className:"move-input",children:e.jsxs("form",{onSubmit:A,children:[e.jsx("input",{type:"text",placeholder:"Enter your move...",value:b,onChange:h=>w(h.target.value),disabled:!v}),e.jsx("button",{type:"submit",disabled:!b.trim(),children:"Make Move"})]})})]}),r.status==="FINISHED"&&e.jsxs("div",{className:"game-finished",children:[e.jsx("h2",{children:"Game Over!"}),r.winnerId&&e.jsxs("p",{children:["Winner: ",(g=(_=r.players)==null?void 0:_.find(h=>h.userId===r.winnerId))==null?void 0:g.user.username]})]}),r.status==="ABANDONED"&&e.jsxs("div",{className:"game-abandoned",children:[e.jsx("h2",{children:"Game Abandoned"}),e.jsx("p",{children:"This game was abandoned by the players."})]})]})})]})]})},ws="/territory-ws";function _e(){const[s,t]=c.useState(null);return c.useEffect(()=>{const a=Be(ws,{withCredentials:!0,transports:["websocket","polling"]});return a.on("connect",()=>{console.log("Socket connected:",a.id)}),a.on("disconnect",()=>{console.log("Socket disconnected")}),a.on("error",r=>{console.error("Socket error:",r)}),t(a),()=>{a.close()}},[]),s}const H=20,ve=64,Ss=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8"];function ks({gameId:s,playerColor:t,onMoveComplete:a,initialCenter:r}){const l=c.useRef(null),[i,f]=c.useState({x:(r==null?void 0:r.x)||0,y:(r==null?void 0:r.y)||0,zoom:1}),[b,w]=c.useState(new Map),[j,A]=c.useState(!1),[D,S]=c.useState({x:0,y:0}),[v,G]=c.useState(null),[F,E]=c.useState(new Set),[U,Y]=c.useState(0),[_,g]=c.useState(null),[h,N]=c.useState(null),[k,C]=c.useState(new Map),[Z,ee]=c.useState(null),p=_e(),{theme:y}=Me(),z=c.useCallback(({x:o,y:n})=>{const m=l.current;if(!m)return{x:0,y:0};const u=m.width/2,x=m.height/2;return{x:u+(o-i.x)*H*i.zoom,y:x+(n-i.y)*H*i.zoom}},[i]),d=c.useCallback(({x:o,y:n})=>{const m=l.current;if(!m)return{x:0,y:0};const u=m.width/2,x=m.height/2;return{x:Math.floor((o-u)/(H*i.zoom)+i.x),y:Math.floor((n-x)/(H*i.zoom)+i.y)}},[i]),I=c.useCallback((o,n)=>{const m=o.clientX-n.clientX,u=o.clientY-n.clientY;return Math.sqrt(m*m+u*u)},[]),T=c.useCallback((o,n)=>{var u;const m=(u=l.current)==null?void 0:u.getBoundingClientRect();return m?{x:(o.clientX+n.clientX)/2-m.left,y:(o.clientY+n.clientY)/2-m.top}:{x:0,y:0}},[]),M=c.useCallback(async()=>{const o=l.current;if(!o)return;const n=Math.ceil(Math.max(o.width,o.height)/(H*i.zoom))+2,m=Math.floor(n/2),u={minX:Math.floor(i.x-m),maxX:Math.ceil(i.x+m),minY:Math.floor(i.y-m),maxY:Math.ceil(i.y+m)};try{const x=await J.getRegion(s,u),L=new Map(b);for(const $ in x.cells)for(const q in x.cells[$]){const V=`${$},${q}`;L.set(V,x.cells[$][q])}w(L);const P=new Set;for(let $=u.minX;$<=u.maxX;$+=ve)for(let q=u.minY;q<=u.maxY;q+=ve){const V=Math.floor($/ve),X=Math.floor(q/ve),K=`${V},${X}`;P.add(K),F.has(K)||p==null||p.emit("subscribe-chunk",{gameId:s,chunkId:K})}F.forEach($=>{P.has($)||p==null||p.emit("unsubscribe-chunk",{gameId:s,chunkId:$})}),E(P)}catch(x){console.error("Failed to fetch region:",x)}},[s,i,b,F,p]),R=c.useCallback(()=>{const o=l.current,n=o==null?void 0:o.getContext("2d");if(!o||!n)return;n.clearRect(0,0,o.width,o.height);const m=getComputedStyle(document.documentElement),u=m.getPropertyValue("--bg").trim(),x=m.getPropertyValue("--grid").trim();if(n.fillStyle=u,n.fillRect(0,0,o.width,o.height),i.zoom>=.5){n.strokeStyle=x,n.globalAlpha=Math.min(1,(i.zoom-.3)/.7),n.lineWidth=1;const q=Math.ceil(Math.max(o.width,o.height)/(H*i.zoom))+2,V=Math.floor(q/2);for(let X=-V;X<=V;X++){const K=Math.floor(i.x+X),ae=z({x:K,y:i.y});n.beginPath(),n.moveTo(ae.x,0),n.lineTo(ae.x,o.height),n.stroke()}for(let X=-V;X<=V;X++){const K=Math.floor(i.y+X),ae=z({x:i.x,y:K});n.beginPath(),n.moveTo(0,ae.y),n.lineTo(o.width,ae.y),n.stroke()}n.globalAlpha=1}const P=Math.ceil(Math.max(o.width,o.height)/(H*i.zoom))+2,$=Math.floor(P/2);for(let q=-$;q<=$;q++)for(let V=-$;V<=$;V++){const X=Math.floor(i.x+q),K=Math.floor(i.y+V),ae=`${X},${K}`,Se=b.get(ae),ce=z({x:X,y:K}),le=H*i.zoom,de=k.get(ae);let pe=1,$e=1;if(de){const me=Date.now()-de.startTime-(de.delay||0),ge=de.type==="place"?250:200;if(me>=0&&me<ge){const ke=Math.min(me/ge,1);de.type==="place"?(pe=.1+.9*ke,$e=ke):de.type==="flip"&&(pe=1+.3*Math.sin(ke*Math.PI))}}if(Se!=null){if(n.save(),n.globalAlpha=$e,pe!==1){const me=ce.x+le/2,ge=ce.y+le/2;n.translate(me,ge),n.scale(pe,pe),n.translate(-me,-ge)}n.fillStyle=Ss[Se]||"#333",n.fillRect(ce.x,ce.y,le-1,le-1),n.restore()}v&&v.x===X&&v.y===K&&(n.strokeStyle="#fff",n.lineWidth=2,n.strokeRect(ce.x,ce.y,le-1,le-1),n.lineWidth=1)}n.fillStyle="#fff",n.font="14px monospace",n.fillText(`Position: ${Math.floor(i.x)}, ${Math.floor(i.y)}`,10,20),n.fillText(`Zoom: ${i.zoom.toFixed(2)}x`,10,40)},[i,b,v,z,k,y]);c.useEffect(()=>{M()},[M]),c.useEffect(()=>{r&&(r.x!==i.x||r.y!==i.y)&&(console.log("Centering map on player's first cell:",r),f(o=>({...o,x:r.x,y:r.y})))},[r]),c.useEffect(()=>{const o=()=>{const n=Date.now(),m=new Map;if(k.forEach((u,x)=>{const L=n-u.startTime-(u.delay||0),P=u.type==="place"?250:200;L<P&&m.set(x,u)}),m.size!==k.size&&C(m),m.size>0){const u=requestAnimationFrame(o);ee(u)}else ee(null)};if(k.size>0&&!Z){const n=requestAnimationFrame(o);ee(n)}return()=>{Z&&cancelAnimationFrame(Z)}},[k,Z]);const B=c.useCallback(o=>{C(n=>new Map(n).set(o,{type:"place",startTime:Date.now(),delay:0}))},[]),se=c.useCallback((o,n)=>{const m=Date.now();C(u=>{const x=new Map(u);return o.forEach((L,P)=>{if(L!==n){const $=Math.min(P*80,1e3);x.set(L,{type:"flip",startTime:m,delay:$})}}),x})},[]);c.useEffect(()=>{const o=l.current;if(!o)return;const n=()=>{o.width=o.offsetWidth,o.height=o.offsetHeight,R()};return n(),window.addEventListener("resize",n),()=>{window.removeEventListener("resize",n)}},[R]),c.useEffect(()=>{R()},[R]),c.useEffect(()=>{if(!p)return;const o=n=>{if(!n.changes)return;const m=new Map(b);n.changes.forEach(u=>{const x=`${u.x},${u.y}`;m.set(x,u.ownerColour)}),w(m)};return p.on("update",o),()=>{p.off("update",o)}},[p,b]);const ie=o=>{l.current.getBoundingClientRect(),o.button===0&&(A(!0),S({x:o.clientX,y:o.clientY}))},re=o=>{const n=l.current.getBoundingClientRect(),m=o.clientX-n.left,u=o.clientY-n.top;if(j){const x=(o.clientX-D.x)/(H*i.zoom),L=(o.clientY-D.y)/(H*i.zoom);f(P=>({...P,x:P.x-x,y:P.y-L})),S({x:o.clientX,y:o.clientY})}else{const x=d({x:m,y:u});G(x)}},De=()=>{A(!1)},We=o=>{o.preventDefault();const n=o.deltaY>0?.9:1.1;f(m=>({...m,zoom:Math.max(.1,Math.min(5,m.zoom*n))}))},Ve=async o=>{if(j)return;const n=l.current.getBoundingClientRect(),m=o.clientX-n.left,u=o.clientY-n.top,x=d({x:m,y:u});await Pe(x.x,x.y)};c.useEffect(()=>{const o=l.current;o&&(o.zoomIn=()=>{f(n=>({...n,zoom:Math.min(5,n.zoom*1.2)}))},o.zoomOut=()=>{f(n=>({...n,zoom:Math.max(.1,n.zoom/1.2)}))},o.centerView=()=>{f({x:0,y:0,zoom:1})})},[]);const He=o=>{if(o.touches.length===2){o.preventDefault(),A(!1),g(null);const n=o.touches[0],m=o.touches[1],u=I(n,m),x=T(n,m),L=d(x);N({initialDistance:u,initialZoom:i.zoom,center:L});return}if(o.touches.length===1){o.preventDefault();const n=o.touches[0],m=l.current.getBoundingClientRect(),u=n.clientX-m.left,x=n.clientY-m.top;g({x:u,y:x}),A(!0),S({x:n.clientX,y:n.clientY});const L=Date.now();if(L-U<300){const P=d({x:u,y:x});f($=>({x:P.x,y:P.y,zoom:Math.min(5,$.zoom*1.5)}))}Y(L)}},Je=o=>{if(o.touches.length===2&&h){o.preventDefault();const n=o.touches[0],m=o.touches[1],u=I(n,m),x=T(n,m),L=u/h.initialDistance,P=Math.max(.1,Math.min(5,h.initialZoom*L));d(x);const $=P/i.zoom;f(q=>({x:h.center.x+(q.x-h.center.x)/$,y:h.center.y+(q.y-h.center.y)/$,zoom:P}));return}if(o.touches.length===1&&j&&_){o.preventDefault();const n=o.touches[0],m=(n.clientX-D.x)/(H*i.zoom),u=(n.clientY-D.y)/(H*i.zoom);f(x=>({...x,x:x.x-m,y:x.y-u})),S({x:n.clientX,y:n.clientY})}},Ze=o=>{if(o.touches.length===0){if(o.preventDefault(),N(null),!_){A(!1);return}const n=o.changedTouches[0],m=l.current.getBoundingClientRect(),u=n.clientX-m.left,x=n.clientY-m.top;if(Math.sqrt(Math.pow(u-_.x,2)+Math.pow(x-_.y,2))<10&&j){const P=d({x:u,y:x});Pe(P.x,P.y)}A(!1),g(null)}else if(o.touches.length===1&&h){N(null);const n=o.touches[0],m=l.current.getBoundingClientRect(),u=n.clientX-m.left,x=n.clientY-m.top;g({x:u,y:x}),A(!0),S({x:n.clientX,y:n.clientY})}},Pe=async(o,n)=>{const m=`${o},${n}`;try{B(m);const u=await J.makeMove(s,o,n);u!=null&&u.captured&&u.captured.length>1&&se(u.captured,m),a&&a(u)}catch(u){console.error("Failed to make move:",u),C(x=>{const L=new Map(x);return L.delete(m),L})}};return e.jsxs("div",{style:{position:"relative",width:"100%",height:"100%"},children:[e.jsx("canvas",{ref:l,className:"territory-canvas",style:{width:"100%",height:"100%",cursor:j?"grabbing":"crosshair",imageRendering:"pixelated"},onMouseDown:ie,onMouseMove:re,onMouseUp:De,onMouseLeave:De,onWheel:We,onClick:Ve,onTouchStart:He,onTouchMove:Je,onTouchEnd:Ze,onContextMenu:o=>o.preventDefault()}),e.jsxs("div",{style:{position:"absolute",top:10,left:10,background:"rgba(0,0,0,0.8)",color:"white",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontFamily:"monospace",pointerEvents:"none"},children:["Position: ",Math.floor(i.x),", ",Math.floor(i.y),e.jsx("br",{}),"Zoom: ",i.zoom.toFixed(2),"x",e.jsx("br",{}),v&&`Target: (${v.x}, ${v.y})`]})]})}let Cs=0;const fe=[];let oe=null;const Le=(s,t="info",a=3e3)=>{const r={id:++Cs,message:s,type:t,duration:a};oe?(oe(l=>[...l,r]),setTimeout(()=>{Xe(r.id)},a)):fe.length<10&&fe.push(r)},Xe=s=>{oe&&(oe(t=>t.map(a=>a.id===s?{...a,removing:!0}:a)),setTimeout(()=>{oe(t=>t.filter(a=>a.id!==s))},300))};function Ts(){const[s,t]=c.useState([]);return c.useEffect(()=>{if(oe=t,fe.length>0){const a=fe.splice(0);t(a),a.forEach(r=>{setTimeout(()=>{Xe(r.id)},r.duration)})}return()=>{oe=null,t([]),fe.length=0}},[]),e.jsx("div",{className:"toast-container",children:s.map(a=>e.jsx("div",{className:`toast ${a.type} ${a.removing?"removing":""}`,children:a.message},a.id))})}function As({current:s,max:t,nextRegenAt:a,currentTime:r}){const l=s/t*100,i=()=>{if(!a||s>=t)return"";const f=Math.max(0,new Date(a)-r),b=Math.ceil(f/1e3);return b<=0?"Regenerating...":`+1 in ${b}s`};return e.jsxs("div",{className:"moves-bar",children:[e.jsx("div",{className:"moves-progress",children:e.jsx("div",{className:"moves-fill",style:{width:`${l}%`}})}),e.jsxs("div",{className:"moves-text",children:[s,"/",t]}),a&&s<t&&e.jsx("div",{className:"moves-regen",style:{fontSize:"10px",color:"var(--text-dim)",marginLeft:"8px"},children:i()})]})}const Es=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8"];function Is({scoreboard:s,currentPlayerColor:t,lastActivePlayer:a}){const r=l=>l.split(" ").map(i=>i[0]).join("").toUpperCase().slice(0,2);return e.jsxs("div",{className:"enhanced-scoreboard",children:[e.jsx("h4",{style:{color:"var(--text)",marginBottom:"12px",fontSize:"14px"},children:"Players"}),s.map(l=>{const i=l.colour===t,f=l.colour===a;return e.jsxs("div",{className:`scoreboard-row ${i?"current-player":""} ${f?"player-acting":""}`,children:[e.jsx("div",{className:"player-swatch",style:{backgroundColor:Es[l.colour]||"#666",border:i?"2px solid var(--accent)":"1px solid var(--grid)"}}),e.jsxs("div",{className:"player-name",children:[i&&"★ ",r(l.username),i&&" (You)"]}),e.jsx("div",{className:"player-score",children:l.count||0})]},l.colour)})]})}function Ms(){const{gameId:s}=Fe(),t=ye(),{user:a}=he(),r=_e(),{toggleTheme:l,isDark:i}=Me(),[f,b]=c.useState(null),[w,j]=c.useState(null),[A,D]=c.useState(0),[S,v]=c.useState(null),[G,F]=c.useState([]),[E,U]=c.useState(null),[Y,_]=c.useState(new Date),[g,h]=c.useState(!1),[N,k]=c.useState(!1);c.useEffect(()=>(document.body.classList.add("territory-mode"),()=>{document.body.classList.remove("territory-mode")}),[]);const C=c.useCallback(async(p=0)=>{var y,z;if(!(!s||!a))try{const d=await J.getAvailableMoves(s);D(d.availableMoves||0),v(d.nextRegenAt)}catch(d){if(((y=d.response)==null?void 0:y.status)===401&&p<3){setTimeout(()=>C(p+1),(p+1)*500);return}((z=d.response)==null?void 0:z.status)===401&&(D(0),v(null))}},[s,a]),Z=c.useCallback(async p=>{await C(),p!=null&&p.captured&&p.captured>1?Le(`Chain capture x${p.captured}!`,"success"):Le("Territory claimed!","info")},[C]),ee=c.useCallback(()=>{const p=document.querySelector(".territory-canvas");p&&p.centerView&&p.centerView()},[]);return c.useEffect(()=>{if(!s||!a)return;j(null),D(0),v(null),F([]),U(null);const p=new AbortController;let y=!0;return(async()=>{var d,I,T,M,R;if(!N)try{k(!0);const B=await J.joinGame(s);if(!y)return;j(B);const se=r;se&&y&&se.emit("join-game",s)}catch(B){if(((d=B.response)==null?void 0:d.status)===400&&((T=(I=B.response)==null?void 0:I.data)==null?void 0:T.error)==="Already joined this game")try{const se=await J.getScoreboard(s);if(!y)return;const ie=se.find(re=>re.username===(a==null?void 0:a.username));if(ie){j({colour:ie.colour});const re=r;re&&y&&re.emit("join-game",s)}else y&&U("Could not determine player info")}catch{y&&U("Game not found or inaccessible")}else y&&U(((R=(M=B.response)==null?void 0:M.data)==null?void 0:R.error)||"Failed to join game")}finally{k(!1)}})(),()=>{y=!1,p.abort()}},[s,a]),c.useEffect(()=>{const p=z=>{r&&s&&r.emit("leave-game",s)},y=()=>{document.visibilityState==="visible"&&r&&s&&r.emit("join-game",s)};return window.addEventListener("beforeunload",p),document.addEventListener("visibilitychange",y),()=>{window.removeEventListener("beforeunload",p),document.removeEventListener("visibilitychange",y)}},[r,s]),c.useEffect(()=>{if(r&&s&&w){const p=()=>{r.emit("join-game",s)};return r.on("connect",p),()=>{r.off("connect",p)}}},[r,s,w]),c.useEffect(()=>{if(s&&w&&a){const p=setTimeout(()=>{C()},100),y=setInterval(C,5e3);return()=>{clearTimeout(p),clearInterval(y)}}},[s,w,a,C]),c.useEffect(()=>{const p=async()=>{if(a)try{const y=await J.getScoreboard(s);F(y)}catch(y){console.error("Failed to fetch scoreboard:",y)}};if(s&&a){p();const y=setInterval(p,1e4);return()=>{clearInterval(y)}}},[s,a]),c.useEffect(()=>{if(!r)return;const p=y=>{if(y.scores){const z=y.scores.map(d=>({colour:d.colour,count:d.count,username:d.username||`Player ${d.colour}`}));F(z)}};return r.on("update",p),()=>{r.off("update",p)}},[r]),c.useEffect(()=>{const p=setInterval(()=>{_(new Date)},1e3);return()=>clearInterval(p)},[]),E?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",background:"#1a1a1a",color:"white"},children:[e.jsx("h2",{children:"Territory Game Error"}),e.jsx("p",{children:E}),e.jsx("button",{onClick:()=>t("/dashboard"),style:{marginTop:"20px",padding:"10px 20px",background:"#4ECDC4",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Back to Dashboard"})]}):e.jsxs("div",{className:"territory-game-container",children:[e.jsxs("div",{className:"floating-game-info",children:[e.jsx("button",{className:"game-info-toggle",onClick:()=>h(!g),children:e.jsxs("div",{className:"burger-icon",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),g&&e.jsxs("div",{className:"game-info-panel",children:[e.jsxs("div",{className:"game-info-header",children:[e.jsx("h4",{children:"Game Info"}),w&&e.jsxs("div",{className:"player-info-compact",children:[e.jsx("div",{className:"player-color-indicator-small",style:{background:w.colour!==void 0?["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8"][w.colour]:"#666"}}),e.jsxs("span",{children:["#",w.colour]})]})]}),e.jsx(Is,{scoreboard:G,currentPlayerColor:w==null?void 0:w.colour}),e.jsxs("div",{className:"game-info-actions",children:[e.jsxs("button",{onClick:l,className:"compact-theme-button",title:`Switch to ${i?"light":"dark"} mode`,children:[i?"☀️":"🌙"," ",i?"Light":"Dark"]}),e.jsx("button",{onClick:()=>t("/dashboard"),className:"compact-leave-button",children:"Leave Game"})]})]})]}),e.jsxs("div",{className:"territory-main-area",children:[e.jsx("div",{className:"territory-canvas-container",children:e.jsx(ks,{gameId:s,playerColor:w==null?void 0:w.colour,onMoveComplete:Z,initialCenter:w==null?void 0:w.firstCell})}),e.jsx(Ts,{}),e.jsxs("div",{className:"mobile-toolbar",children:[e.jsx("button",{className:"toolbar-button",onClick:ee,title:"Center View",children:"⌖"}),e.jsx("div",{className:"toolbar-moves",children:e.jsx(As,{current:A,max:25,nextRegenAt:S,currentTime:Y})}),e.jsxs("div",{className:"toolbar-zoom",children:[e.jsx("button",{className:"toolbar-button",onTouchStart:p=>{p.preventDefault();const y=document.querySelector(".territory-canvas");y&&y.zoomOut&&y.zoomOut()},title:"Zoom Out",children:"−"}),e.jsx("button",{className:"toolbar-button",onTouchStart:p=>{p.preventDefault();const y=document.querySelector(".territory-canvas");y&&y.zoomIn&&y.zoomIn()},title:"Zoom In",children:"+"})]})]})]})]})}function Ds(){const{theme:s,toggleTheme:t,isDark:a}=Me();return e.jsx("button",{className:"theme-toggle",onClick:t,title:`Switch to ${a?"light":"dark"} mode`,"aria-label":`Switch to ${a?"light":"dark"} mode`,children:a?"☀️":"🌙"})}function Ps(){return e.jsx(gs,{children:e.jsx(ps,{children:e.jsx(Qe,{basename:"/territory",children:e.jsxs("div",{className:"app",children:[e.jsx(Ds,{}),e.jsxs(es,{children:[e.jsx(ue,{path:"/",element:e.jsx(Ge,{to:"/dashboard",replace:!0})}),e.jsx(ue,{path:"/login",element:e.jsx(xs,{})}),e.jsx(ue,{path:"/signup",element:e.jsx(fs,{})}),e.jsx(ue,{path:"/dashboard",element:e.jsx(Ae,{children:e.jsx(ys,{})})}),e.jsx(ue,{path:"/game/:id",element:e.jsx(Ae,{children:e.jsx(bs,{})})}),e.jsx(ue,{path:"/:gameId",element:e.jsx(Ae,{children:e.jsx(Ms,{})})})]})]})})})})}Ee.createRoot(document.getElementById("root")).render(e.jsx(ss.StrictMode,{children:e.jsx(Ps,{})}));
