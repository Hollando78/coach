import{r as c,a as Ke,N as Ge,u as ye,L as be,b as Fe,B as Qe,R as es,c as ue,d as ss}from"./vendor-ycPT9Mzr.js";import{a as ze,l as Oe}from"./api-Bs1G8lkK.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))r(l);new MutationObserver(l=>{for(const i of l)if(i.type==="childList")for(const x of i.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&r(x)}).observe(document,{childList:!0,subtree:!0});function a(l){const i={};return l.integrity&&(i.integrity=l.integrity),l.referrerPolicy&&(i.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?i.credentials="include":l.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(l){if(l.ep)return;l.ep=!0;const i=a(l);fetch(l.href,i)}})();var Be={exports:{}},we={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ts=c,rs=Symbol.for("react.element"),as=Symbol.for("react.fragment"),ns=Object.prototype.hasOwnProperty,os=ts.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,is={key:!0,ref:!0,__self:!0,__source:!0};function Ue(s,t,a){var r,l={},i=null,x=null;a!==void 0&&(i=""+a),t.key!==void 0&&(i=""+t.key),t.ref!==void 0&&(x=t.ref);for(r in t)ns.call(t,r)&&!is.hasOwnProperty(r)&&(l[r]=t[r]);if(s&&s.defaultProps)for(r in t=s.defaultProps,t)l[r]===void 0&&(l[r]=t[r]);return{$$typeof:rs,type:s,key:i,ref:x,props:l,_owner:os.current}}we.Fragment=as;we.jsx=Ue;we.jsxs=Ue;Be.exports=we;var e=Be.exports,Ie={},Re=Ke;Ie.createRoot=Re.createRoot,Ie.hydrateRoot=Re.hydrateRoot;const cs="/territory-api";let V=null,Se=[];const B=ze.create({baseURL:cs,withCredentials:!0,timeout:3e4});B.interceptors.request.use(s=>{var t;return console.log("📤 API Request:",{url:s.url,method:(t=s.method)==null?void 0:t.toUpperCase(),hasToken:!!V,tokenStart:V?V.substring(0,20)+"...":"none",timestamp:new Date().toLocaleTimeString()}),V&&!s.url.includes("/auth/")&&(s.headers.Authorization=`Bearer ${V}`),s},s=>Promise.reject(s));let Te=!1,Me=[];const ls=s=>{Me.push(s)},ds=s=>{Me.forEach(t=>t(s)),Me=[]};B.interceptors.response.use(s=>s,async s=>{var a,r,l,i;const t=s.config;if(console.log("🔍 API Error Interceptor:",{url:t.url,status:(a=s.response)==null?void 0:a.status,data:(r=s.response)==null?void 0:r.data,hasToken:!!V,isRetry:t._retry,timestamp:new Date().toLocaleTimeString()}),((l=s.response)==null?void 0:l.status)===401&&!t._retry&&!t.url.includes("/auth/")){if(console.log("🔄 Attempting token refresh..."),Te)return console.log("⏳ Token refresh already in progress, queuing request..."),new Promise(x=>{ls(b=>{t.headers.Authorization=`Bearer ${b}`,x(B(t))})});t._retry=!0,Te=!0;try{return console.log("🚀 Calling refresh endpoint..."),V=(await B.post("/auth/refresh")).data.accessToken,Se.forEach(b=>b(V)),console.log("✅ Token refreshed successfully"),ds(V),t.headers.Authorization=`Bearer ${V}`,console.log("🔁 Retrying original request..."),B(t)}catch(x){return console.log("❌ Token refresh failed:",(i=x.response)==null?void 0:i.data),V=null,console.log("🚪 Redirecting to login..."),window.location.href="/login",Promise.reject(x)}finally{Te=!1}}return Promise.reject(s)});const Ee=s=>{V=s,Se.forEach(t=>t(s))},ms=()=>{V=null,Se.forEach(s=>s(null))},us=s=>{Se.push(s)},ve={signup:(s,t,a)=>B.post("/auth/signup",{email:s,username:t,password:a}),login:(s,t)=>B.post("/auth/login",{email:s,password:t}),logout:()=>B.post("/auth/logout"),refresh:()=>B.post("/auth/refresh")},xe={getGames:()=>B.get("/games"),createGame:(s,t,a=2)=>B.post("/games",{title:s,gameType:t,maxPlayers:a}),getGame:s=>B.get(`/games/${s}`),joinGame:s=>B.post(`/games/${s}/join`),addPlayer:(s,t)=>B.post(`/games/${s}/players`,{identifier:t}),makeMove:(s,t)=>B.post(`/games/${s}/moves`,{moveData:t}),updateGameState:(s,t,a,r)=>B.put(`/games/${s}/state`,{gameState:t,status:a,winnerId:r}),deleteGame:s=>B.delete(`/games/${s}`)},hs="/territory-api",ee=ze.create({baseURL:hs,withCredentials:!0,timeout:3e4,headers:{"Content-Type":"application/json"}});let te=null;us(s=>{te=s});ee.interceptors.request.use(s=>{var t;return console.log("🎯 Territory API Request:",{url:s.url,method:(t=s.method)==null?void 0:t.toUpperCase(),hasToken:!!te,tokenStart:te?te.substring(0,20)+"...":"none",timestamp:new Date().toLocaleTimeString()}),te&&(s.headers.Authorization=`Bearer ${te}`),s},s=>Promise.reject(s));ee.interceptors.response.use(s=>(console.log("✅ Territory API Response:",{url:s.config.url,status:s.status,timestamp:new Date().toLocaleTimeString()}),s),async s=>{var a,r,l,i,x;const t=s.config;if(console.log("❌ Territory API Error:",{url:(t==null?void 0:t.url)||"unknown",status:(a=s.response)==null?void 0:a.status,data:(r=s.response)==null?void 0:r.data,message:s.message,code:s.code,timestamp:new Date().toLocaleTimeString()}),s.code==="ECONNABORTED"||(l=s.message)!=null&&l.includes("timeout"))return console.log("⏱️ Request timed out after 30 seconds"),s.customMessage="Request timed out. The server may be experiencing high load.",Promise.reject(s);if(!s.response&&s.message==="Network Error")return console.log("🔌 Network error - cannot reach server"),s.customMessage="Cannot connect to server. Please check your connection.",Promise.reject(s);if((i=s.message)!=null&&i.includes("aborted"))return console.log("🚫 Request was aborted, not retrying"),Promise.reject(s);if(((x=s.response)==null?void 0:x.status)===401&&!t._retry){console.log("🔄 Territory API: Attempting token refresh..."),t._retry=!0;try{if(te=(await ee.post("/auth/refresh")).data.accessToken,console.log("✅ Territory API: Token refreshed"),te)return t.headers.Authorization=`Bearer ${te}`,ee(t)}catch(b){return console.log("❌ Territory API: Token refresh failed, redirecting to login"),window.location.href="/login",Promise.reject(b)}}return Promise.reject(s)});const Z={setAuthToken:s=>{te=s},createGame:async s=>(await ee.post("/territory/create",{title:s})).data,joinGame:async s=>(await ee.post(`/territory/${s}/join`)).data,getRegion:async(s,t)=>{const a=new URLSearchParams({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY});return(await ee.get(`/territory/${s}/region?${a}`)).data},getAvailableMoves:async s=>(await ee.get(`/territory/${s}/moves`)).data,makeMove:async(s,t,a)=>(await ee.post(`/territory/${s}/move`,{x:t,y:a})).data,addPlayer:async(s,t)=>(await ee.post(`/territory/${s}/players`,{identifier:t})).data,getScoreboard:async s=>(await ee.get(`/territory/${s}/scoreboard`)).data},qe=c.createContext(),he=()=>{const s=c.useContext(qe);if(!s)throw new Error("useAuth must be used within AuthProvider");return s},ps=({children:s})=>{const[t,a]=c.useState(null),[r,l]=c.useState(!0);c.useEffect(()=>{i()},[]);const i=async()=>{try{const T=await ve.refresh();a(T.data.user),Ee(T.data.accessToken),Z.setAuthToken(T.data.accessToken)}catch{console.log("Not authenticated")}finally{l(!1)}},j={user:t,loading:r,signup:async(T,I,k)=>{const v=await ve.signup(T,I,k);return a(v.data.user),Ee(v.data.accessToken),Z.setAuthToken(v.data.accessToken),v.data},login:async(T,I)=>{const k=await ve.login(T,I);return a(k.data.user),Ee(k.data.accessToken),Z.setAuthToken(k.data.accessToken),k.data},logout:async()=>{try{await ve.logout()}catch(T){console.error("Logout error:",T)}finally{a(null),ms(),Z.setAuthToken(null)}}};return e.jsx(qe.Provider,{value:j,children:s})},Ye=c.createContext(),De=()=>{const s=c.useContext(Ye);if(!s)throw new Error("useTheme must be used within a ThemeProvider");return s},gs=({children:s})=>{const[t,a]=c.useState(()=>localStorage.getItem("game-theme")||"dark");c.useEffect(()=>{localStorage.setItem("game-theme",t),document.documentElement.setAttribute("data-theme",t)},[t]);const l={theme:t,toggleTheme:()=>{a(i=>i==="dark"?"light":"dark")},isDark:t==="dark",isLight:t==="light"};return e.jsx(Ye.Provider,{value:l,children:s})},Ae=({children:s})=>{const{user:t,loading:a}=he();return a?e.jsx("div",{className:"loading",children:"Loading..."}):t?s:e.jsx(Ge,{to:"/login",replace:!0})},xs=()=>{const[s,t]=c.useState(""),[a,r]=c.useState(""),[l,i]=c.useState(!1),[x,b]=c.useState(""),[w,j]=c.useState(""),[T,I]=c.useState([]),[k,v]=c.useState(null),[$,z]=c.useState(!1),{login:U}=he(),q=ye(),A=(m,C="info")=>{const y=new Date().toLocaleTimeString();I(S=>[...S.slice(-9),{timestamp:y,message:m,type:C}])},_=async()=>{j("Testing API connection..."),A("Starting API health check","info");try{const m="/territory-api/health";j(`Testing: ${m}`),A(`Testing URL: ${m}`,"info");const C=performance.now(),y=await fetch(m,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)}),S=Math.round(performance.now()-C);if(A(`Response time: ${S}ms`,"success"),A(`Status: ${y.status} ${y.statusText}`,y.ok?"success":"error"),!y.ok)throw new Error(`HTTP ${y.status}: ${y.statusText}`);const X=await y.json();j(`✅ API OK | URL: ${m} | Response: ${JSON.stringify(X)}`),A(`API Response: ${JSON.stringify(X)}`,"success")}catch(m){A(`Error: ${m.message}`,"error"),m.name==="TimeoutError"||m.message.includes("timeout")?j("❌ TIMEOUT | URL might be wrong or server down | Tried: /territory-api"):m.name==="TypeError"&&m.message.includes("fetch")?(j("❌ NETWORK ERROR | Can't reach server | Check if territory backend is running"),A("Network error - server unreachable","error")):j(`❌ API FAILED | Error: ${m.message} | Type: ${m.name}`)}},G=async m=>{var C,y,S,X,se,p,f,O,d,E,R;m.preventDefault(),i(!0),b(""),j("Starting login..."),A(`Login attempt for: ${s}`,"info"),v(null);try{A("Login URL: /territory-api/auth/login","info"),j("Calling API...");const F=performance.now();await U(s,a);const L=Math.round(performance.now()-F);A(`Login successful in ${L}ms`,"success"),j("Login successful, redirecting..."),q("/dashboard")}catch(N){const F=((y=(C=N.response)==null?void 0:C.config)==null?void 0:y.responseTime)||"unknown",L=((X=(S=N.response)==null?void 0:S.data)==null?void 0:X.error)||N.message||"Login failed",K=((se=N.response)==null?void 0:se.status)||"Unknown",oe=((p=N.response)==null?void 0:p.statusText)||"No status text",re="/territory-api",je=((O=(f=N.response)==null?void 0:f.config)==null?void 0:O.url)||"Unknown URL";b(L),v({message:L,status:K,statusText:oe,url:je,responseTime:F,details:((d=N.response)==null?void 0:d.data)||{},timestamp:new Date().toISOString()}),A(`Login failed: ${L}`,"error"),A(`Status: ${K} ${oe}`,"error"),A(`Response time: ${F}`,"error"),(E=N.response)!=null&&E.data&&A(`Server response: ${JSON.stringify(N.response.data)}`,"error"),j(`❌ LOGIN FAILED | Error: ${L} | Status: ${K} | API: ${re}`),console.error("Login error details:",{error:N,response:N.response,message:N.message,stack:N.stack,config:(R=N.response)==null?void 0:R.config})}finally{i(!1)}};return e.jsxs("div",{className:"territory-auth-container",children:[e.jsx("div",{className:"territory-grid-bg"}),e.jsxs("div",{className:"territory-auth-overlay",children:[e.jsxs("div",{className:"territory-auth-form",children:[e.jsxs("div",{className:"territory-logo-section",children:[e.jsx("div",{className:"territory-logo",children:e.jsxs("div",{className:"logo-grid",children:[e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"})]})}),e.jsx("h1",{children:"Territory Conquest"}),e.jsx("p",{className:"territory-tagline",children:"Claim your domain. Expand your empire."})]}),x&&e.jsx("div",{className:"territory-error",children:x}),w&&e.jsx("div",{className:"territory-debug-info",children:w}),e.jsxs("form",{onSubmit:G,className:"territory-form",children:[e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"email",placeholder:"Email Address",value:s,onChange:m=>t(m.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"password",placeholder:"Password",value:a,onChange:m=>r(m.target.value),required:!0,className:"territory-input"})}),e.jsxs("button",{type:"submit",disabled:l,className:"territory-login-btn",children:[e.jsx("span",{className:"btn-grid-effect"}),l?"⚡ Connecting...":"🏁 Enter Battle"]})]}),e.jsx("div",{className:"territory-signup-link",children:e.jsxs("p",{children:["New commander? ",e.jsx(be,{to:"/signup",className:"territory-link",children:"Join the conquest"})]})})]}),e.jsxs("div",{className:"territory-diagnostics-footer",children:[e.jsxs("button",{type:"button",className:"territory-diagnostics-toggle",onClick:()=>z(!$),children:[e.jsx("span",{children:"System Diagnostics"}),e.jsx("span",{className:`toggle-icon ${$?"open":""}`,children:"▼"})]}),$&&e.jsxs("div",{className:"territory-diagnostics-panel",children:[e.jsxs("div",{className:"territory-connection-info",children:[e.jsx("h4",{children:"System Information"}),e.jsxs("div",{className:"info-grid",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"API Endpoint:"})," ","/territory-api"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Host:"})," ",typeof window<"u"?window.location.host:"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Protocol:"})," ",typeof window<"u"?window.location.protocol:"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Environment:"})," Production"]})]})]}),e.jsxs("div",{className:"territory-diagnostic-tools",children:[e.jsx("h4",{children:"Diagnostic Tools"}),e.jsxs("div",{className:"territory-test-buttons",children:[e.jsx("button",{type:"button",className:"territory-btn-test api",onClick:_,children:"🔗 Test API Connection"}),e.jsx("button",{type:"button",className:"territory-btn-test direct",onClick:()=>window.open(`${window.location.origin}/territory-api/health`,"_blank"),children:"🚀 Direct API Test"}),e.jsx("button",{type:"button",className:"territory-btn-test clear",onClick:()=>{I([]),v(null),j("")},children:"🗑️ Clear Logs"})]})]}),T.length>0&&e.jsxs("div",{className:"territory-diagnostics-log",children:[e.jsx("h4",{children:"Network Activity Log"}),e.jsx("div",{className:"diagnostics-entries",children:T.map((m,C)=>e.jsxs("div",{className:`diagnostic-entry ${m.type}`,children:[e.jsx("span",{className:"diagnostic-time",children:m.timestamp}),e.jsx("span",{className:"diagnostic-message",children:m.message})]},C))})]}),k&&e.jsxs("div",{className:"territory-error-details",children:[e.jsx("h4",{children:"Last Error Details"}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Message:"})," ",k.message]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Status:"})," ",k.status," ",k.statusText]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"URL:"})," ",k.url]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Time:"})," ",new Date(k.timestamp).toLocaleString()]}),Object.keys(k.details).length>0&&e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Response:"}),e.jsx("pre",{children:JSON.stringify(k.details,null,2)})]})]})]})]})]})]})},fs=()=>{const[s,t]=c.useState(""),[a,r]=c.useState(""),[l,i]=c.useState(""),[x,b]=c.useState(!1),[w,j]=c.useState(""),{signup:T}=he(),I=ye(),k=async v=>{var $,z;v.preventDefault(),b(!0),j("");try{await T(s,a,l),I("/dashboard")}catch(U){j(((z=($=U.response)==null?void 0:$.data)==null?void 0:z.error)||"Signup failed")}finally{b(!1)}};return e.jsxs("div",{className:"territory-auth-container",children:[e.jsx("div",{className:"territory-grid-bg"}),e.jsx("div",{className:"territory-auth-overlay",children:e.jsxs("div",{className:"territory-auth-form",children:[e.jsxs("div",{className:"territory-logo-section",children:[e.jsx("div",{className:"territory-logo",children:e.jsxs("div",{className:"logo-grid",children:[e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"})]})}),e.jsx("h1",{children:"Join the Conquest"}),e.jsx("p",{className:"territory-tagline",children:"Establish your command. Build your empire."})]}),w&&e.jsx("div",{className:"territory-error",children:w}),e.jsxs("form",{onSubmit:k,className:"territory-form",children:[e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"email",placeholder:"Email Address",value:s,onChange:v=>t(v.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"text",placeholder:"Commander Username",value:a,onChange:v=>r(v.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"password",placeholder:"Password (minimum 6 characters)",value:l,onChange:v=>i(v.target.value),required:!0,minLength:6,className:"territory-input"})}),e.jsxs("button",{type:"submit",disabled:x,className:"territory-login-btn",children:[e.jsx("span",{className:"btn-grid-effect"}),x?"⚡ Establishing Command...":"🚀 Begin Conquest"]})]}),e.jsx("div",{className:"territory-signup-link",children:e.jsxs("p",{children:["Already a commander? ",e.jsx(be,{to:"/login",className:"territory-link",children:"Enter the battle"})]})})]})})]})},ys=()=>{var O;const[s,t]=c.useState([]),[a,r]=c.useState(!0),[l,i]=c.useState(!1),[x,b]=c.useState(!1),[w,j]=c.useState({title:"",gameType:"territory",maxPlayers:8}),[T,I]=c.useState(null),[k,v]=c.useState(""),[$,z]=c.useState(!1),[U,q]=c.useState(null),[A,_]=c.useState(!1),{user:G,logout:m}=he(),C=ye();c.useEffect(()=>{y()},[]);const y=async()=>{var d;try{const E=await xe.getGames();t(E.data)}catch(E){console.error("Failed to load games:",E),(d=E.response)==null||d.status}finally{r(!1)}},S=async d=>{var E,R;d.preventDefault(),i(!0);try{const N=await Z.createGame(w.title);C(`/territory/${N.id}`),b(!1),j({title:"",gameType:"territory",maxPlayers:8})}catch(N){console.error("Failed to create game:",N),alert(`Failed to create game: ${((R=(E=N.response)==null?void 0:E.data)==null?void 0:R.error)||N.message}`)}finally{i(!1)}},X=async(d,E)=>{var R,N;z(!0);try{await Z.addPlayer(d,E),await y(),I(null),v("")}catch(F){console.error("Failed to add player:",F),alert(((N=(R=F.response)==null?void 0:R.data)==null?void 0:N.error)||"Failed to add player")}finally{z(!1)}},se=async d=>{var E,R;_(!0);try{await xe.deleteGame(d),await y(),q(null)}catch(N){console.error("Failed to delete game:",N),alert(((R=(E=N.response)==null?void 0:E.data)==null?void 0:R.error)||"Failed to delete game")}finally{_(!1)}},p=d=>{var E;switch(d.status){case"WAITING":return`Waiting for players (${(E=d.players)==null?void 0:E.length}/${d.maxPlayers})`;case"ACTIVE":return"In progress";case"FINISHED":return"Finished";case"ABANDONED":return"Abandoned";default:return d.status}},f=d=>{switch(d){case"WAITING":return"status-waiting";case"ACTIVE":return"status-active";case"FINISHED":return"status-finished";case"ABANDONED":return"status-abandoned";default:return""}};return a?e.jsx("div",{className:"loading",children:"Loading games..."}):e.jsxs("div",{className:"territory-dashboard",children:[e.jsx("div",{className:"dashboard-bg-grid"}),e.jsxs("div",{className:"dashboard-overlay",children:[e.jsxs("header",{className:"territory-dashboard-header",children:[e.jsxs("div",{className:"dashboard-title-section",children:[e.jsx("div",{className:"dashboard-logo",children:e.jsxs("div",{className:"dashboard-logo-grid",children:[e.jsx("div",{className:"logo-cell active player1"}),e.jsx("div",{className:"logo-cell active player2"}),e.jsx("div",{className:"logo-cell active player3"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player3"})]})}),e.jsxs("div",{className:"dashboard-title-text",children:[e.jsx("h1",{children:"Command Center"}),e.jsxs("p",{className:"welcome-commander",children:["Welcome back, Commander ",G==null?void 0:G.username,"!"]}),e.jsxs("div",{className:"status-indicator",children:[e.jsx("span",{className:"status-dot online"}),e.jsx("span",{className:"status-text",children:"Systems Online"})]})]})]}),e.jsxs("div",{className:"dashboard-actions",children:[e.jsxs("button",{onClick:()=>b(!0),className:"territory-btn-primary",children:[e.jsx("span",{className:"btn-icon",children:"⚔️"}),e.jsx("span",{children:"New Campaign"})]}),e.jsxs("button",{onClick:m,className:"territory-btn-logout",children:[e.jsx("span",{className:"btn-icon",children:"🚪"}),e.jsx("span",{children:"Logout"})]})]})]}),x&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"🗺️ Launch New Campaign"}),e.jsx("div",{className:"modal-subtitle",children:"Establish your territory and expand your dominion"})]}),e.jsxs("form",{onSubmit:S,className:"territory-create-form",children:[e.jsxs("div",{className:"territory-form-group",children:[e.jsxs("label",{className:"territory-label",children:[e.jsx("span",{className:"label-icon",children:"📝"}),e.jsx("span",{children:"Campaign Name"})]}),e.jsx("input",{type:"text",placeholder:"Enter campaign name...",value:w.title,onChange:d=>j({...w,title:d.target.value}),required:!0,className:"territory-input"})]}),e.jsxs("div",{className:"campaign-info",children:[e.jsxs("div",{className:"info-header",children:[e.jsx("span",{className:"info-icon",children:"⚔️"}),e.jsx("span",{className:"info-title",children:"Territory Conquest"})]}),e.jsxs("div",{className:"info-features",children:[e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"🏰"}),e.jsx("span",{children:"Real-time strategy gameplay"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"🎯"}),e.jsx("span",{children:"Enclosed area capture mechanics"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"👥"}),e.jsx("span",{children:"Up to 8 commanders"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"⚡"}),e.jsx("span",{children:"Move regeneration system"})]})]})]}),e.jsxs("div",{className:"territory-form-actions",children:[e.jsxs("button",{type:"button",onClick:()=>b(!1),className:"territory-btn-cancel",children:[e.jsx("span",{className:"btn-icon",children:"❌"}),e.jsx("span",{children:"Cancel"})]}),e.jsxs("button",{type:"submit",disabled:l,className:"territory-btn-create",children:[e.jsx("span",{className:"btn-icon",children:l?"⏳":"🚀"}),e.jsx("span",{children:l?"Launching...":"Launch Campaign"})]})]})]})]})}),e.jsxs("div",{className:"territory-games-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"🏰 Active Campaigns"}),e.jsxs("div",{className:"section-stats",children:[e.jsxs("span",{className:"stat-item",children:[e.jsx("span",{className:"stat-icon",children:"📊"}),e.jsxs("span",{className:"stat-text",children:[s.length," Total"]})]}),e.jsxs("span",{className:"stat-item",children:[e.jsx("span",{className:"stat-icon",children:"⚡"}),e.jsxs("span",{className:"stat-text",children:[s.filter(d=>d.status==="ACTIVE").length," Active"]})]})]})]}),s.length===0?e.jsxs("div",{className:"territory-empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:e.jsxs("div",{className:"empty-grid",children:[e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell center",children:"?"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"})]})}),e.jsx("h3",{children:"No Campaigns Found"}),e.jsx("p",{children:"Begin your conquest by creating your first territory campaign!"}),e.jsxs("button",{onClick:()=>b(!0),className:"territory-btn-primary",children:[e.jsx("span",{className:"btn-icon",children:"⚔️"}),e.jsx("span",{children:"Start First Campaign"})]})]}):e.jsx("div",{className:"territory-games-grid",children:s.map(d=>{var E,R,N;return e.jsxs("div",{className:"territory-game-card",children:[e.jsxs("div",{className:"game-card-header",children:[e.jsxs("div",{className:"game-title-section",children:[e.jsx("h3",{children:d.title}),e.jsxs("div",{className:"game-type-badge",children:[e.jsx("span",{className:"badge-icon",children:"🗺️"}),e.jsx("span",{children:"Territory"})]})]}),e.jsxs("div",{className:`territory-status ${f(d.status)}`,children:[e.jsx("span",{className:"status-icon",children:js(d.status)}),e.jsx("span",{className:"status-label",children:p(d)})]})]}),e.jsxs("div",{className:"game-preview",children:[e.jsx("div",{className:"preview-grid",children:Array.from({length:25},(F,L)=>e.jsx("div",{className:`preview-cell ${d.players&&d.players.length>0?L%3===0?"occupied p1":L%5===0?"occupied p2":"":""}`},L))}),e.jsx("div",{className:"preview-overlay",children:e.jsx("span",{className:"preview-text",children:"Campaign Preview"})})]}),e.jsxs("div",{className:"game-info",children:[e.jsxs("div",{className:"commander-info",children:[e.jsx("span",{className:"commander-label",children:"Commander:"}),e.jsx("span",{className:"commander-name",children:d.owner.username})]}),e.jsxs("div",{className:"players-roster",children:[e.jsx("span",{className:"roster-label",children:"Forces:"}),e.jsxs("div",{className:"player-indicators",children:[(E=d.players)==null?void 0:E.slice(0,3).map((F,L)=>e.jsx("div",{className:`player-badge p${L+1}`,children:F.user.username.charAt(0).toUpperCase()},F.id)),d.players&&d.players.length>3&&e.jsxs("div",{className:"player-badge more",children:["+",d.players.length-3]}),!d.players||d.players.length===0&&e.jsx("div",{className:"no-players",children:"Awaiting reinforcements"})]})]})]}),e.jsxs("div",{className:"territory-game-actions",children:[e.jsxs(be,{to:`/${d.id}`,className:"territory-btn-play",children:[e.jsx("span",{className:"btn-icon",children:d.status==="FINISHED"?"👁️":"⚡"}),e.jsx("span",{children:d.status==="FINISHED"?"Inspect":"Deploy"})]}),d.ownerId===(G==null?void 0:G.id)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>I(d.id),className:"territory-btn-secondary",disabled:((R=d.players)==null?void 0:R.length)>=8,title:((N=d.players)==null?void 0:N.length)>=8?"Maximum 8 commanders":"Recruit commander",children:[e.jsx("span",{className:"btn-icon",children:"👥"}),e.jsx("span",{children:"Recruit"})]}),e.jsxs("button",{onClick:()=>q(d.id),className:"territory-btn-danger",title:"Abandon Campaign",children:[e.jsx("span",{className:"btn-icon",children:"💥"}),e.jsx("span",{children:"Abandon"})]})]})]})]},d.id)})})]})]}),T&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"👥 Recruit Commander"}),e.jsx("div",{className:"modal-subtitle",children:"Add a new commander to your campaign"})]}),e.jsxs("form",{onSubmit:d=>{d.preventDefault(),k.trim()&&X(T,k.trim())},className:"territory-recruit-form",children:[e.jsxs("div",{className:"territory-form-group",children:[e.jsxs("label",{className:"territory-label",children:[e.jsx("span",{className:"label-icon",children:"🔍"}),e.jsx("span",{children:"Commander Identifier"})]}),e.jsx("input",{type:"text",placeholder:"Enter email or username...",value:k,onChange:d=>v(d.target.value),disabled:$,autoFocus:!0,className:"territory-input"})]}),e.jsx("div",{className:"recruit-info",children:e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-icon",children:"ℹ️"}),e.jsx("span",{children:"Commanders can immediately join and start conquering territory"})]})}),e.jsxs("div",{className:"territory-form-actions",children:[e.jsxs("button",{type:"button",onClick:()=>{I(null),v("")},className:"territory-btn-cancel",disabled:$,children:[e.jsx("span",{className:"btn-icon",children:"❌"}),e.jsx("span",{children:"Cancel"})]}),e.jsxs("button",{type:"submit",className:"territory-btn-create",disabled:!k.trim()||$,children:[e.jsx("span",{className:"btn-icon",children:$?"⏳":"👥"}),e.jsx("span",{children:$?"Recruiting...":"Recruit Commander"})]})]})]})]})}),U&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content danger",children:[e.jsxs("div",{className:"modal-header danger",children:[e.jsx("h2",{children:"💥 Abandon Campaign"}),e.jsx("div",{className:"modal-subtitle",children:"This action will permanently destroy the campaign"})]}),e.jsxs("div",{className:"danger-warning",children:[e.jsx("div",{className:"warning-icon",children:"⚠️"}),e.jsxs("div",{className:"warning-content",children:[e.jsx("p",{children:e.jsx("strong",{children:"This cannot be undone!"})}),e.jsx("p",{children:"All territory progress, commander data, and battle history will be lost."}),e.jsxs("div",{className:"campaign-details",children:[e.jsx("span",{className:"detail-label",children:"Campaign:"}),e.jsx("span",{className:"detail-value",children:(O=s.find(d=>d.id===U))==null?void 0:O.title})]})]})]}),e.jsxs("div",{className:"territory-form-actions danger",children:[e.jsxs("button",{type:"button",onClick:()=>q(null),className:"territory-btn-cancel",disabled:A,children:[e.jsx("span",{className:"btn-icon",children:"🛡️"}),e.jsx("span",{children:"Keep Campaign"})]}),e.jsxs("button",{type:"button",onClick:()=>se(U),className:"territory-btn-danger-confirm",disabled:A,children:[e.jsx("span",{className:"btn-icon",children:A?"⏳":"💥"}),e.jsx("span",{children:A?"Abandoning...":"Abandon Campaign"})]})]})]})})]})},js=s=>{switch(s){case"WAITING":return"⏳";case"ACTIVE":return"⚡";case"FINISHED":return"🏆";case"ABANDONED":return"💀";default:return"❓"}},vs="/territory-ws";class Ns{constructor(){this.socket=null,this.gameId=null}connect(){return this.socket||(this.socket=Oe(vs,{withCredentials:!0}),this.socket.on("connect",()=>{console.log("Connected to socket server")}),this.socket.on("disconnect",()=>{console.log("Disconnected from socket server")})),this.socket}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.gameId=null)}joinGame(t){this.socket&&t!==this.gameId&&(this.gameId&&this.socket.emit("leave-game",this.gameId),this.gameId=t,this.socket.emit("join-game",t))}leaveGame(){this.socket&&this.gameId&&(this.socket.emit("leave-game",this.gameId),this.gameId=null)}emitMove(t,a){this.socket&&this.socket.emit("game-move",{gameId:t,moveData:a})}emitStateChange(t,a,r,l){this.socket&&this.socket.emit("game-state-change",{gameId:t,gameState:a,status:r,winnerId:l})}onMoveMade(t){this.socket&&this.socket.on("move-made",t)}onStateUpdated(t){this.socket&&this.socket.on("state-updated",t)}offMoveMade(t){this.socket&&this.socket.off("move-made",t)}offStateUpdated(t){this.socket&&this.socket.off("state-updated",t)}}const ne=new Ns,bs=()=>{var z,U,q,A,_,G;const{id:s}=Fe(),t=ye(),{user:a}=he(),[r,l]=c.useState(null),[i,x]=c.useState(!0),[b,w]=c.useState(""),j=c.useCallback(async()=>{var m,C,y;try{console.log("🎮 Loading game:",s,"for user:",a==null?void 0:a.username);const S=await xe.getGame(s);console.log("✅ Game loaded successfully:",S.data.title),l(S.data)}catch(S){console.error("❌ Failed to load game:",S),console.error("Error details:",{status:(m=S.response)==null?void 0:m.status,data:(C=S.response)==null?void 0:C.data,gameId:s,user:a==null?void 0:a.username}),((y=S.response)==null?void 0:y.status)===404&&(console.log("🚪 Game not found, redirecting to dashboard"),t("/dashboard"))}finally{x(!1)}},[s,t,a]);c.useEffect(()=>{j()},[j]),c.useEffect(()=>{if(r){ne.connect(),ne.joinGame(r.id);const m=y=>{console.log("Move made:",y),j()},C=y=>{console.log("State updated:",y),j()};return ne.onMoveMade(m),ne.onStateUpdated(C),()=>{ne.offMoveMade(m),ne.offStateUpdated(C),ne.leaveGame()}}},[r,j]);const T=async m=>{var C,y;if(m.preventDefault(),!!b.trim())try{const S={action:b.trim(),timestamp:Date.now()};await xe.makeMove(s,S),ne.emitMove(s,S),w(""),j()}catch(S){console.error("Failed to make move:",S),alert(((y=(C=S.response)==null?void 0:C.data)==null?void 0:y.error)||"Failed to make move")}},I=async()=>{var m,C;try{await xe.joinGame(s),j()}catch(y){console.error("Failed to join game:",y),alert(((C=(m=y.response)==null?void 0:m.data)==null?void 0:C.error)||"Failed to join game")}};if(i)return e.jsx("div",{className:"loading",children:"Loading game..."});if(!r)return e.jsx("div",{className:"error",children:"Game not found"});const k=(z=r.players)==null?void 0:z.some(m=>m.userId===(a==null?void 0:a.id));r.ownerId,a==null||a.id;const v=r.currentTurn===(a==null?void 0:a.id),$=(U=r.players)==null?void 0:U.find(m=>m.userId===r.currentTurn);return e.jsxs("div",{className:"game-room",children:[e.jsx("header",{className:"game-header",children:e.jsxs("div",{children:[e.jsx(be,{to:"/dashboard",className:"back-link",children:"← Back to Dashboard"}),e.jsx("h1",{children:r.title}),e.jsxs("div",{className:"game-meta",children:[e.jsx("span",{className:"game-type",children:r.gameType}),e.jsx("span",{className:`status status-${r.status.toLowerCase()}`,children:r.status})]})]})}),e.jsxs("div",{className:"game-content",children:[e.jsxs("div",{className:"game-sidebar",children:[e.jsxs("div",{className:"players-section",children:[e.jsxs("h3",{children:["Players (",(q=r.players)==null?void 0:q.length,"/",r.maxPlayers,")"]}),e.jsx("div",{className:"players-list",children:(A=r.players)==null?void 0:A.map(m=>e.jsxs("div",{className:`player ${m.userId===r.currentTurn?"current-turn":""}`,children:[e.jsx("span",{className:"player-name",children:m.user.username}),m.userId===r.ownerId&&e.jsx("span",{className:"owner-badge",children:"Owner"}),m.userId===r.currentTurn&&e.jsx("span",{className:"turn-indicator",children:"Current Turn"})]},m.id))}),!k&&r.status==="WAITING"&&e.jsx("button",{onClick:I,className:"btn-primary",children:"Join Game"})]}),r.moves&&r.moves.length>0&&e.jsxs("div",{className:"moves-section",children:[e.jsx("h3",{children:"Game Log"}),e.jsx("div",{className:"moves-list",children:r.moves.map(m=>{var C;return e.jsxs("div",{className:"move",children:[e.jsxs("span",{className:"move-player",children:[(C=m.user)==null?void 0:C.username,":"]}),e.jsx("span",{className:"move-data",children:typeof m.moveData=="string"?m.moveData:JSON.stringify(m.moveData)})]},m.id)})})]})]}),e.jsx("div",{className:"game-main",children:e.jsxs("div",{className:"game-board",children:[r.status==="WAITING"&&e.jsxs("div",{className:"waiting-message",children:[e.jsx("h2",{children:"Waiting for players..."}),e.jsx("p",{children:"Share this URL with friends to invite them to play!"})]}),r.status==="ACTIVE"&&e.jsxs("div",{className:"game-active",children:[e.jsx("div",{className:"turn-indicator",children:v?e.jsx("h3",{children:"Your turn!"}):e.jsxs("h3",{children:["Waiting for ",$==null?void 0:$.user.username,"'s move..."]})}),r.gameState&&e.jsxs("div",{className:"game-state",children:[e.jsx("h4",{children:"Game State:"}),e.jsx("pre",{children:typeof r.gameState=="string"?r.gameState:JSON.stringify(r.gameState,null,2)})]}),k&&v&&e.jsx("div",{className:"move-input",children:e.jsxs("form",{onSubmit:T,children:[e.jsx("input",{type:"text",placeholder:"Enter your move...",value:b,onChange:m=>w(m.target.value),disabled:!v}),e.jsx("button",{type:"submit",disabled:!b.trim(),children:"Make Move"})]})})]}),r.status==="FINISHED"&&e.jsxs("div",{className:"game-finished",children:[e.jsx("h2",{children:"Game Over!"}),r.winnerId&&e.jsxs("p",{children:["Winner: ",(G=(_=r.players)==null?void 0:_.find(m=>m.userId===r.winnerId))==null?void 0:G.user.username]})]}),r.status==="ABANDONED"&&e.jsxs("div",{className:"game-abandoned",children:[e.jsx("h2",{children:"Game Abandoned"}),e.jsx("p",{children:"This game was abandoned by the players."})]})]})})]})]})},ws="/territory-ws";function _e(){const[s,t]=c.useState(null);return c.useEffect(()=>{const a=Oe(ws,{withCredentials:!0,transports:["websocket","polling"]});return a.on("connect",()=>{console.log("Socket connected:",a.id)}),a.on("disconnect",()=>{console.log("Socket disconnected")}),a.on("error",r=>{console.error("Socket error:",r)}),t(a),()=>{a.close()}},[]),s}const J=20,Ne=64,Ss=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8"];function ks({gameId:s,playerColor:t,onMoveComplete:a,initialCenter:r}){const l=c.useRef(null),[i,x]=c.useState({x:(r==null?void 0:r.x)||0,y:(r==null?void 0:r.y)||0,zoom:1}),[b,w]=c.useState(new Map),[j,T]=c.useState(!1),[I,k]=c.useState({x:0,y:0}),[v,$]=c.useState(null),[z,U]=c.useState(new Set),[q,A]=c.useState(0),[_,G]=c.useState(null),[m,C]=c.useState(null),[y,S]=c.useState(new Map),[X,se]=c.useState(null),p=_e(),{theme:f}=De(),O=c.useCallback(({x:o,y:n})=>{const u=l.current;if(!u)return{x:0,y:0};const h=u.width/2,g=u.height/2;return{x:h+(o-i.x)*J*i.zoom,y:g+(n-i.y)*J*i.zoom}},[i]),d=c.useCallback(({x:o,y:n})=>{const u=l.current;if(!u)return{x:0,y:0};const h=u.width/2,g=u.height/2;return{x:Math.floor((o-h)/(J*i.zoom)+i.x),y:Math.floor((n-g)/(J*i.zoom)+i.y)}},[i]),E=c.useCallback((o,n)=>{const u=o.clientX-n.clientX,h=o.clientY-n.clientY;return Math.sqrt(u*u+h*h)},[]),R=c.useCallback((o,n)=>{var h;const u=(h=l.current)==null?void 0:h.getBoundingClientRect();return u?{x:(o.clientX+n.clientX)/2-u.left,y:(o.clientY+n.clientY)/2-u.top}:{x:0,y:0}},[]),N=c.useCallback(async()=>{const o=l.current;if(!o)return;const n=Math.ceil(Math.max(o.width,o.height)/(J*i.zoom))+2,u=Math.floor(n/2),h={minX:Math.floor(i.x-u),maxX:Math.ceil(i.x+u),minY:Math.floor(i.y-u),maxY:Math.ceil(i.y+u)};try{const g=await Z.getRegion(s,h),P=new Map(b);for(const D in g.cells)for(const Y in g.cells[D]){const H=`${D},${Y}`;P.set(H,g.cells[D][Y])}w(P);const M=new Set;for(let D=h.minX;D<=h.maxX;D+=Ne)for(let Y=h.minY;Y<=h.maxY;Y+=Ne){const H=Math.floor(D/Ne),W=Math.floor(Y/Ne),Q=`${H},${W}`;M.add(Q),z.has(Q)||p==null||p.emit("subscribe-chunk",{gameId:s,chunkId:Q})}z.forEach(D=>{M.has(D)||p==null||p.emit("unsubscribe-chunk",{gameId:s,chunkId:D})}),U(M)}catch(g){console.error("Failed to fetch region:",g)}},[s,i,b,z,p]),F=c.useCallback(()=>{const o=l.current,n=o==null?void 0:o.getContext("2d");if(!o||!n)return;n.clearRect(0,0,o.width,o.height);const u=getComputedStyle(document.documentElement),h=u.getPropertyValue("--bg").trim(),g=u.getPropertyValue("--grid").trim();if(n.fillStyle=h,n.fillRect(0,0,o.width,o.height),i.zoom>=.5){n.strokeStyle=g,n.globalAlpha=Math.min(1,(i.zoom-.3)/.7),n.lineWidth=1;const Y=Math.ceil(Math.max(o.width,o.height)/(J*i.zoom))+2,H=Math.floor(Y/2);for(let W=-H;W<=H;W++){const Q=Math.floor(i.x+W),ae=O({x:Q,y:i.y});n.beginPath(),n.moveTo(ae.x,0),n.lineTo(ae.x,o.height),n.stroke()}for(let W=-H;W<=H;W++){const Q=Math.floor(i.y+W),ae=O({x:i.x,y:Q});n.beginPath(),n.moveTo(0,ae.y),n.lineTo(o.width,ae.y),n.stroke()}n.globalAlpha=1}const M=Math.ceil(Math.max(o.width,o.height)/(J*i.zoom))+2,D=Math.floor(M/2);for(let Y=-D;Y<=D;Y++)for(let H=-D;H<=D;H++){const W=Math.floor(i.x+Y),Q=Math.floor(i.y+H),ae=`${W},${Q}`,ke=b.get(ae),ce=O({x:W,y:Q}),le=J*i.zoom,de=y.get(ae);let pe=1,$e=1;if(de){const me=Date.now()-de.startTime-(de.delay||0),ge=de.type==="place"?250:200;if(me>=0&&me<ge){const Ce=Math.min(me/ge,1);de.type==="place"?(pe=.1+.9*Ce,$e=Ce):de.type==="flip"&&(pe=1+.3*Math.sin(Ce*Math.PI))}}if(ke!=null){if(n.save(),n.globalAlpha=$e,pe!==1){const me=ce.x+le/2,ge=ce.y+le/2;n.translate(me,ge),n.scale(pe,pe),n.translate(-me,-ge)}n.fillStyle=Ss[ke]||"#333",n.fillRect(ce.x,ce.y,le-1,le-1),n.restore()}v&&v.x===W&&v.y===Q&&(n.strokeStyle="#fff",n.lineWidth=2,n.strokeRect(ce.x,ce.y,le-1,le-1),n.lineWidth=1)}n.fillStyle="#fff",n.font="14px monospace",n.fillText(`Position: ${Math.floor(i.x)}, ${Math.floor(i.y)}`,10,20),n.fillText(`Zoom: ${i.zoom.toFixed(2)}x`,10,40)},[i,b,v,O,y,f]);c.useEffect(()=>{N()},[N]),c.useEffect(()=>{r&&(r.x!==i.x||r.y!==i.y)&&(console.log("Centering map on player's first cell:",r),x(o=>({...o,x:r.x,y:r.y})))},[r]),c.useEffect(()=>{const o=()=>{const n=Date.now(),u=new Map;if(y.forEach((h,g)=>{const P=n-h.startTime-(h.delay||0),M=h.type==="place"?250:200;P<M&&u.set(g,h)}),u.size!==y.size&&S(u),u.size>0){const h=requestAnimationFrame(o);se(h)}else se(null)};if(y.size>0&&!X){const n=requestAnimationFrame(o);se(n)}return()=>{X&&cancelAnimationFrame(X)}},[y,X]);const L=c.useCallback(o=>{S(n=>new Map(n).set(o,{type:"place",startTime:Date.now(),delay:0}))},[]),K=c.useCallback((o,n)=>{const u=Date.now();S(h=>{const g=new Map(h);return o.forEach((P,M)=>{if(P!==n){const D=Math.min(M*80,1e3);g.set(P,{type:"flip",startTime:u,delay:D})}}),g})},[]);c.useEffect(()=>{const o=l.current;if(!o)return;const n=()=>{o.width=o.offsetWidth,o.height=o.offsetHeight,F()};return n(),window.addEventListener("resize",n),()=>{window.removeEventListener("resize",n)}},[F]),c.useEffect(()=>{F()},[F]),c.useEffect(()=>{if(!p)return;const o=n=>{if(!n.changes)return;const u=new Map(b);n.changes.forEach(h=>{const g=`${h.x},${h.y}`;u.set(g,h.ownerColour)}),w(u)};return p.on("update",o),()=>{p.off("update",o)}},[p,b]);const oe=o=>{l.current.getBoundingClientRect(),o.button===0&&(T(!0),k({x:o.clientX,y:o.clientY}))},re=o=>{const n=l.current.getBoundingClientRect(),u=o.clientX-n.left,h=o.clientY-n.top;if(j){const g=(o.clientX-I.x)/(J*i.zoom),P=(o.clientY-I.y)/(J*i.zoom);x(M=>({...M,x:M.x-g,y:M.y-P})),k({x:o.clientX,y:o.clientY})}else{const g=d({x:u,y:h});$(g)}},je=()=>{T(!1)},We=o=>{o.preventDefault();const n=o.deltaY>0?.9:1.1;x(u=>({...u,zoom:Math.max(.1,Math.min(5,u.zoom*n))}))},Ve=async o=>{if(j)return;const n=l.current.getBoundingClientRect(),u=o.clientX-n.left,h=o.clientY-n.top,g=d({x:u,y:h});await Pe(g.x,g.y)};c.useEffect(()=>{const o=l.current;o&&(o.zoomIn=()=>{x(n=>({...n,zoom:Math.min(5,n.zoom*1.2)}))},o.zoomOut=()=>{x(n=>({...n,zoom:Math.max(.1,n.zoom/1.2)}))},o.centerView=()=>{x({x:0,y:0,zoom:1})})},[]);const He=o=>{if(o.touches.length===2){o.preventDefault(),T(!1),G(null);const n=o.touches[0],u=o.touches[1],h=E(n,u),g=R(n,u),P=d(g);C({initialDistance:h,initialZoom:i.zoom,center:P});return}if(o.touches.length===1){o.preventDefault();const n=o.touches[0],u=l.current.getBoundingClientRect(),h=n.clientX-u.left,g=n.clientY-u.top;G({x:h,y:g}),T(!0),k({x:n.clientX,y:n.clientY});const P=Date.now();if(P-q<300){const M=d({x:h,y:g});x(D=>({x:M.x,y:M.y,zoom:Math.min(5,D.zoom*1.5)}))}A(P)}},Je=o=>{if(o.touches.length===2&&m){o.preventDefault();const n=o.touches[0],u=o.touches[1],h=E(n,u),g=R(n,u),P=h/m.initialDistance,M=Math.max(.1,Math.min(5,m.initialZoom*P));d(g);const D=M/i.zoom;x(Y=>({x:m.center.x+(Y.x-m.center.x)/D,y:m.center.y+(Y.y-m.center.y)/D,zoom:M}));return}if(o.touches.length===1&&j&&_){o.preventDefault();const n=o.touches[0],u=(n.clientX-I.x)/(J*i.zoom),h=(n.clientY-I.y)/(J*i.zoom);x(g=>({...g,x:g.x-u,y:g.y-h})),k({x:n.clientX,y:n.clientY})}},Ze=o=>{if(o.touches.length===0){if(o.preventDefault(),C(null),!_){T(!1);return}const n=o.changedTouches[0],u=l.current.getBoundingClientRect(),h=n.clientX-u.left,g=n.clientY-u.top;if(Math.sqrt(Math.pow(h-_.x,2)+Math.pow(g-_.y,2))<10&&j){const M=d({x:h,y:g});Pe(M.x,M.y)}T(!1),G(null)}else if(o.touches.length===1&&m){C(null);const n=o.touches[0],u=l.current.getBoundingClientRect(),h=n.clientX-u.left,g=n.clientY-u.top;G({x:h,y:g}),T(!0),k({x:n.clientX,y:n.clientY})}},Pe=async(o,n)=>{const u=`${o},${n}`;try{L(u);const h=await Z.makeMove(s,o,n);h!=null&&h.captured&&h.captured.length>1&&K(h.captured,u),a&&a(h)}catch(h){console.error("Failed to make move:",h),S(g=>{const P=new Map(g);return P.delete(u),P})}};return e.jsxs("div",{style:{position:"relative",width:"100%",height:"100%"},children:[e.jsx("canvas",{ref:l,className:"territory-canvas",style:{width:"100%",height:"100%",cursor:j?"grabbing":"crosshair",imageRendering:"pixelated"},onMouseDown:oe,onMouseMove:re,onMouseUp:je,onMouseLeave:je,onWheel:We,onClick:Ve,onTouchStart:He,onTouchMove:Je,onTouchEnd:Ze,onContextMenu:o=>o.preventDefault()}),e.jsxs("div",{style:{position:"absolute",top:10,left:10,background:"rgba(0,0,0,0.8)",color:"white",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontFamily:"monospace",pointerEvents:"none"},children:["Position: ",Math.floor(i.x),", ",Math.floor(i.y),e.jsx("br",{}),"Zoom: ",i.zoom.toFixed(2),"x",e.jsx("br",{}),v&&`Target: (${v.x}, ${v.y})`]})]})}let Cs=0;const fe=[];let ie=null;const Le=(s,t="info",a=3e3)=>{const r={id:++Cs,message:s,type:t,duration:a};ie?(ie(l=>[...l,r]),setTimeout(()=>{Xe(r.id)},a)):fe.length<10&&fe.push(r)},Xe=s=>{ie&&(ie(t=>t.map(a=>a.id===s?{...a,removing:!0}:a)),setTimeout(()=>{ie(t=>t.filter(a=>a.id!==s))},300))};function Ts(){const[s,t]=c.useState([]);return c.useEffect(()=>{if(ie=t,fe.length>0){const a=fe.splice(0);t(a),a.forEach(r=>{setTimeout(()=>{Xe(r.id)},r.duration)})}return()=>{ie=null,t([]),fe.length=0}},[]),e.jsx("div",{className:"toast-container",children:s.map(a=>e.jsx("div",{className:`toast ${a.type} ${a.removing?"removing":""}`,children:a.message},a.id))})}function Es({current:s,max:t,nextRegenAt:a,currentTime:r}){const l=s/t*100,i=()=>{if(!a||s>=t)return"";const x=Math.max(0,new Date(a)-r),b=Math.ceil(x/1e3);return b<=0?"Regenerating...":`+1 in ${b}s`};return e.jsxs("div",{className:"moves-bar",children:[e.jsx("div",{className:"moves-progress",children:e.jsx("div",{className:"moves-fill",style:{width:`${l}%`}})}),e.jsxs("div",{className:"moves-text",children:[s,"/",t]}),a&&s<t&&e.jsx("div",{className:"moves-regen",style:{fontSize:"10px",color:"var(--text-dim)",marginLeft:"8px"},children:i()})]})}const As=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8"];function Is({scoreboard:s,currentPlayerColor:t,lastActivePlayer:a}){const r=l=>l.split(" ").map(i=>i[0]).join("").toUpperCase().slice(0,2);return e.jsxs("div",{className:"enhanced-scoreboard",children:[e.jsx("h4",{style:{color:"var(--text)",marginBottom:"12px",fontSize:"14px"},children:"Players"}),s.map(l=>{const i=l.colour===t,x=l.colour===a;return e.jsxs("div",{className:`scoreboard-row ${i?"current-player":""} ${x?"player-acting":""}`,children:[e.jsx("div",{className:"player-swatch",style:{backgroundColor:As[l.colour]||"#666",border:i?"2px solid var(--accent)":"1px solid var(--grid)"}}),e.jsxs("div",{className:"player-name",children:[i&&"★ ",r(l.username),i&&" (You)"]}),e.jsx("div",{className:"player-score",children:l.count||0})]},l.colour)})]})}function Ms(){const{gameId:s}=Fe(),t=ye(),{user:a}=he(),r=_e(),{toggleTheme:l,isDark:i}=De(),[x,b]=c.useState(null),[w,j]=c.useState(null),[T,I]=c.useState(0),[k,v]=c.useState(null),[$,z]=c.useState([]),[U,q]=c.useState(null),[A,_]=c.useState(new Date),[G,m]=c.useState(!1),[C,y]=c.useState(!1);c.useEffect(()=>(document.body.classList.add("territory-mode"),()=>{document.body.classList.remove("territory-mode")}),[]);const S=c.useCallback(async(p=0)=>{var f,O;if(!(!s||!a))try{const d=await Z.getAvailableMoves(s);I(d.availableMoves||0),v(d.nextRegenAt)}catch(d){if(((f=d.response)==null?void 0:f.status)===401&&p<3){setTimeout(()=>S(p+1),(p+1)*500);return}((O=d.response)==null?void 0:O.status)===401&&(I(0),v(null))}},[s,a]),X=c.useCallback(async p=>{await S(),p!=null&&p.captured&&p.captured>1?Le(`Chain capture x${p.captured}!`,"success"):Le("Territory claimed!","info")},[S]),se=c.useCallback(()=>{const p=document.querySelector(".territory-canvas");p&&p.centerView&&p.centerView()},[]);return c.useEffect(()=>{if(!s||!a)return;j(null),I(0),v(null),z([]),q(null);const p=new AbortController;let f=!0;return(async()=>{var d,E,R,N,F;if(!C)try{y(!0);const L=await Z.joinGame(s);if(!f)return;j(L);const K=r;K&&f&&K.emit("join-game",s)}catch(L){if(((d=L.response)==null?void 0:d.status)===400&&((R=(E=L.response)==null?void 0:E.data)==null?void 0:R.error)==="Already joined this game")try{const K=await Z.getScoreboard(s);if(!f)return;const oe=K.find(re=>re.username===(a==null?void 0:a.username));if(oe){j({colour:oe.colour});const re=r;re&&f&&re.emit("join-game",s)}else f&&q("Could not determine player info")}catch{f&&q("Game not found or inaccessible")}else f&&q(((F=(N=L.response)==null?void 0:N.data)==null?void 0:F.error)||"Failed to join game")}finally{y(!1)}})(),()=>{f=!1,p.abort()}},[s,a]),c.useEffect(()=>{const p=O=>{r&&s&&r.emit("leave-game",s)},f=()=>{document.visibilityState==="visible"&&r&&s&&r.emit("join-game",s)};return window.addEventListener("beforeunload",p),document.addEventListener("visibilitychange",f),()=>{window.removeEventListener("beforeunload",p),document.removeEventListener("visibilitychange",f)}},[r,s]),c.useEffect(()=>{if(r&&s&&w){const p=()=>{r.emit("join-game",s)};return r.on("connect",p),()=>{r.off("connect",p)}}},[r,s,w]),c.useEffect(()=>{if(s&&w&&a){const p=setTimeout(()=>{S()},100),f=setInterval(S,5e3);return()=>{clearTimeout(p),clearInterval(f)}}},[s,w,a,S]),c.useEffect(()=>{const p=async()=>{if(a)try{const f=await Z.getScoreboard(s);z(f)}catch(f){console.error("Failed to fetch scoreboard:",f)}};if(s&&a){p();const f=setInterval(p,1e4);return()=>{clearInterval(f)}}},[s,a]),c.useEffect(()=>{if(!r)return;const p=f=>{if(f.scores){const O=f.scores.map(d=>({colour:d.colour,count:d.count,username:d.username||`Player ${d.colour}`}));z(O)}};return r.on("update",p),()=>{r.off("update",p)}},[r]),c.useEffect(()=>{const p=setInterval(()=>{_(new Date)},1e3);return()=>clearInterval(p)},[]),U?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",background:"#1a1a1a",color:"white"},children:[e.jsx("h2",{children:"Territory Game Error"}),e.jsx("p",{children:U}),e.jsx("button",{onClick:()=>t("/dashboard"),style:{marginTop:"20px",padding:"10px 20px",background:"#4ECDC4",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Back to Dashboard"})]}):e.jsxs("div",{className:"territory-game-container",children:[e.jsxs("div",{className:"floating-game-info",children:[e.jsx("button",{className:"game-info-toggle",onClick:()=>m(!G),children:e.jsxs("div",{className:"burger-icon",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),G&&e.jsxs("div",{className:"game-info-panel",children:[e.jsxs("div",{className:"game-info-header",children:[e.jsx("h4",{children:"Game Info"}),w&&e.jsxs("div",{className:"player-info-compact",children:[e.jsx("div",{className:"player-color-indicator-small",style:{background:w.colour!==void 0?["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8"][w.colour]:"#666"}}),e.jsxs("span",{children:["#",w.colour]})]})]}),e.jsx(Is,{scoreboard:$,currentPlayerColor:w==null?void 0:w.colour}),e.jsxs("div",{className:"game-info-actions",children:[e.jsxs("button",{onClick:l,className:"compact-theme-button",title:`Switch to ${i?"light":"dark"} mode`,children:[i?"☀️":"🌙"," ",i?"Light":"Dark"]}),e.jsx("button",{onClick:()=>t("/dashboard"),className:"compact-leave-button",children:"Leave Game"})]})]})]}),e.jsxs("div",{className:"territory-main-area",children:[e.jsx("div",{className:"territory-canvas-container",children:e.jsx(ks,{gameId:s,playerColor:w==null?void 0:w.colour,onMoveComplete:X,initialCenter:w==null?void 0:w.firstCell})}),e.jsx(Ts,{}),e.jsxs("div",{className:"mobile-toolbar",children:[e.jsx("button",{className:"toolbar-button",onClick:se,title:"Center View",children:"⌖"}),e.jsx("div",{className:"toolbar-moves",children:e.jsx(Es,{current:T,max:25,nextRegenAt:k,currentTime:A})}),e.jsxs("div",{className:"toolbar-zoom",children:[e.jsx("button",{className:"toolbar-button",onTouchStart:p=>{p.preventDefault();const f=document.querySelector(".territory-canvas");f&&f.zoomOut&&f.zoomOut()},title:"Zoom Out",children:"−"}),e.jsx("button",{className:"toolbar-button",onTouchStart:p=>{p.preventDefault();const f=document.querySelector(".territory-canvas");f&&f.zoomIn&&f.zoomIn()},title:"Zoom In",children:"+"})]})]})]})]})}function Ds(){const{theme:s,toggleTheme:t,isDark:a}=De();return e.jsx("button",{className:"theme-toggle",onClick:t,title:`Switch to ${a?"light":"dark"} mode`,"aria-label":`Switch to ${a?"light":"dark"} mode`,children:a?"☀️":"🌙"})}function Ps(){return e.jsx(gs,{children:e.jsx(ps,{children:e.jsx(Qe,{basename:"/territory",children:e.jsxs("div",{className:"app",children:[e.jsx(Ds,{}),e.jsxs(es,{children:[e.jsx(ue,{path:"/",element:e.jsx(Ge,{to:"/dashboard",replace:!0})}),e.jsx(ue,{path:"/login",element:e.jsx(xs,{})}),e.jsx(ue,{path:"/signup",element:e.jsx(fs,{})}),e.jsx(ue,{path:"/dashboard",element:e.jsx(Ae,{children:e.jsx(ys,{})})}),e.jsx(ue,{path:"/game/:id",element:e.jsx(Ae,{children:e.jsx(bs,{})})}),e.jsx(ue,{path:"/:gameId",element:e.jsx(Ae,{children:e.jsx(Ms,{})})})]})]})})})})}Ie.createRoot(document.getElementById("root")).render(e.jsx(ss.StrictMode,{children:e.jsx(Ps,{})}));
