import{r as i,a as rs,N as qe,u as we,L as Te,b as _e,B as as,R as ns,c as xe,d as os}from"./vendor-ycPT9Mzr.js";import{a as Xe,l as We}from"./api-Bs1G8lkK.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const d of l)if(d.type==="childList")for(const c of d.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function r(l){const d={};return l.integrity&&(d.integrity=l.integrity),l.referrerPolicy&&(d.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?d.credentials="include":l.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function a(l){if(l.ep)return;l.ep=!0;const d=r(l);fetch(l.href,d)}})();var Ve={exports:{}},Ee={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var is=i,cs=Symbol.for("react.element"),ls=Symbol.for("react.fragment"),ds=Object.prototype.hasOwnProperty,ms=is.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,us={key:!0,ref:!0,__self:!0,__source:!0};function He(s,t,r){var a,l={},d=null,c=null;r!==void 0&&(d=""+r),t.key!==void 0&&(d=""+t.key),t.ref!==void 0&&(c=t.ref);for(a in t)ds.call(t,a)&&!us.hasOwnProperty(a)&&(l[a]=t[a]);if(s&&s.defaultProps)for(a in t=s.defaultProps,t)l[a]===void 0&&(l[a]=t[a]);return{$$typeof:cs,type:s,key:d,ref:c,props:l,_owner:ms.current}}Ee.Fragment=ls;Ee.jsx=He;Ee.jsxs=He;Ve.exports=Ee;var e=Ve.exports,Pe={},ze=rs;Pe.createRoot=ze.createRoot,Pe.hydrateRoot=ze.hydrateRoot;const hs="/territory-api";let W=null,Ae=[];const z=Xe.create({baseURL:hs,withCredentials:!0,timeout:3e4});z.interceptors.request.use(s=>{var t;return console.log("📤 API Request:",{url:s.url,method:(t=s.method)==null?void 0:t.toUpperCase(),hasToken:!!W,tokenStart:W?W.substring(0,20)+"...":"none",timestamp:new Date().toLocaleTimeString()}),W&&!s.url.includes("/auth/")&&(s.headers.Authorization=`Bearer ${W}`),s},s=>Promise.reject(s));let Ie=!1,Fe=[];const ps=s=>{Fe.push(s)},gs=s=>{Fe.forEach(t=>t(s)),Fe=[]};z.interceptors.response.use(s=>s,async s=>{var r,a,l,d;const t=s.config;if(console.log("🔍 API Error Interceptor:",{url:t.url,status:(r=s.response)==null?void 0:r.status,data:(a=s.response)==null?void 0:a.data,hasToken:!!W,isRetry:t._retry,timestamp:new Date().toLocaleTimeString()}),((l=s.response)==null?void 0:l.status)===401&&!t._retry&&!t.url.includes("/auth/")){if(console.log("🔄 Attempting token refresh..."),Ie)return console.log("⏳ Token refresh already in progress, queuing request..."),new Promise(c=>{ps(y=>{t.headers.Authorization=`Bearer ${y}`,c(z(t))})});t._retry=!0,Ie=!0;try{return console.log("🚀 Calling refresh endpoint..."),W=(await z.post("/auth/refresh")).data.accessToken,Ae.forEach(y=>y(W)),console.log("✅ Token refreshed successfully"),gs(W),t.headers.Authorization=`Bearer ${W}`,console.log("🔁 Retrying original request..."),z(t)}catch(c){return console.log("❌ Token refresh failed:",(d=c.response)==null?void 0:d.data),W=null,console.log("🚪 Redirecting to login..."),window.location.href="/login",Promise.reject(c)}finally{Ie=!1}}return Promise.reject(s)});const Re=s=>{W=s,Ae.forEach(t=>t(s))},xs=()=>{W=null,Ae.forEach(s=>s(null))},fs=s=>{Ae.push(s)},ke={signup:(s,t,r)=>z.post("/auth/signup",{email:s,username:t,password:r}),login:(s,t)=>z.post("/auth/login",{email:s,password:t}),logout:()=>z.post("/auth/logout"),refresh:()=>z.post("/auth/refresh")},Ne={getGames:()=>z.get("/games"),createGame:(s,t,r=2)=>z.post("/games",{title:s,gameType:t,maxPlayers:r}),getGame:s=>z.get(`/games/${s}`),joinGame:s=>z.post(`/games/${s}/join`),addPlayer:(s,t)=>z.post(`/games/${s}/players`,{identifier:t}),makeMove:(s,t)=>z.post(`/games/${s}/moves`,{moveData:t}),updateGameState:(s,t,r,a)=>z.put(`/games/${s}/state`,{gameState:t,status:r,winnerId:a}),deleteGame:s=>z.delete(`/games/${s}`)},ys="/territory-api",Z=Xe.create({baseURL:ys,withCredentials:!0,timeout:3e4,headers:{"Content-Type":"application/json"}});let se=null;fs(s=>{se=s});Z.interceptors.request.use(s=>{var t;return console.log("🎯 Territory API Request:",{url:s.url,method:(t=s.method)==null?void 0:t.toUpperCase(),hasToken:!!se,tokenStart:se?se.substring(0,20)+"...":"none",timestamp:new Date().toLocaleTimeString()}),se&&(s.headers.Authorization=`Bearer ${se}`),s},s=>Promise.reject(s));Z.interceptors.response.use(s=>(console.log("✅ Territory API Response:",{url:s.config.url,status:s.status,timestamp:new Date().toLocaleTimeString()}),s),async s=>{var r,a,l,d,c;const t=s.config;if(console.log("❌ Territory API Error:",{url:(t==null?void 0:t.url)||"unknown",status:(r=s.response)==null?void 0:r.status,data:(a=s.response)==null?void 0:a.data,message:s.message,code:s.code,timestamp:new Date().toLocaleTimeString()}),s.code==="ECONNABORTED"||(l=s.message)!=null&&l.includes("timeout"))return console.log("⏱️ Request timed out after 30 seconds"),s.customMessage="Request timed out. The server may be experiencing high load.",Promise.reject(s);if(!s.response&&s.message==="Network Error")return console.log("🔌 Network error - cannot reach server"),s.customMessage="Cannot connect to server. Please check your connection.",Promise.reject(s);if((d=s.message)!=null&&d.includes("aborted"))return console.log("🚫 Request was aborted, not retrying"),Promise.reject(s);if(((c=s.response)==null?void 0:c.status)===401&&!t._retry){console.log("🔄 Territory API: Attempting token refresh..."),t._retry=!0;try{if(se=(await Z.post("/auth/refresh")).data.accessToken,console.log("✅ Territory API: Token refreshed"),se)return t.headers.Authorization=`Bearer ${se}`,Z(t)}catch(y){return console.log("❌ Territory API: Token refresh failed, redirecting to login"),window.location.href="/login",Promise.reject(y)}}return Promise.reject(s)});const q={setAuthToken:s=>{se=s},createGame:async s=>(await Z.post("/territory/create",{title:s})).data,joinGame:async s=>(await Z.post(`/territory/${s}/join`)).data,getRegion:async(s,t)=>{const r=new URLSearchParams({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY});return(await Z.get(`/territory/${s}/region?${r}`)).data},getAvailableMoves:async s=>(await Z.get(`/territory/${s}/moves`)).data,makeMove:async(s,t,r)=>(await Z.post(`/territory/${s}/move`,{x:t,y:r})).data,addPlayer:async(s,t)=>(await Z.post(`/territory/${s}/players`,{identifier:t})).data,getScoreboard:async s=>(await Z.get(`/territory/${s}/scoreboard`)).data,selectColor:async(s,t)=>(await Z.put(`/territory/${s}/color`,{colorIndex:t})).data},Je=i.createContext(),ye=()=>{const s=i.useContext(Je);if(!s)throw new Error("useAuth must be used within AuthProvider");return s},js=({children:s})=>{const[t,r]=i.useState(null),[a,l]=i.useState(!0);i.useEffect(()=>{d()},[]);const d=async()=>{try{const v=await ke.refresh();r(v.data.user),Re(v.data.accessToken),q.setAuthToken(v.data.accessToken)}catch{console.log("Not authenticated")}finally{l(!1)}},g={user:t,loading:a,signup:async(v,E,N)=>{const k=await ke.signup(v,E,N);return r(k.data.user),Re(k.data.accessToken),q.setAuthToken(k.data.accessToken),k.data},login:async(v,E)=>{const N=await ke.login(v,E);return r(N.data.user),Re(N.data.accessToken),q.setAuthToken(N.data.accessToken),N.data},logout:async()=>{try{await ke.logout()}catch(v){console.error("Logout error:",v)}finally{r(null),xs(),q.setAuthToken(null)}}};return e.jsx(Je.Provider,{value:g,children:s})},Ze=i.createContext(),Le=()=>{const s=i.useContext(Ze);if(!s)throw new Error("useTheme must be used within a ThemeProvider");return s},vs=({children:s})=>{const[t,r]=i.useState(()=>localStorage.getItem("game-theme")||"dark");i.useEffect(()=>{localStorage.setItem("game-theme",t),document.documentElement.setAttribute("data-theme",t)},[t]);const l={theme:t,toggleTheme:()=>{r(d=>d==="dark"?"light":"dark")},isDark:t==="dark",isLight:t==="light"};return e.jsx(Ze.Provider,{value:l,children:s})},$e=({children:s})=>{const{user:t,loading:r}=ye();return r?e.jsx("div",{className:"loading",children:"Loading..."}):t?s:e.jsx(qe,{to:"/login",replace:!0})},Ns=()=>{const[s,t]=i.useState(""),[r,a]=i.useState(""),[l,d]=i.useState(!1),[c,y]=i.useState(""),[I,g]=i.useState(""),[v,E]=i.useState([]),[N,k]=i.useState(null),[D,O]=i.useState(!1),{login:F}=ye(),_=we(),A=(m,w="info")=>{const C=new Date().toLocaleTimeString();E(S=>[...S.slice(-9),{timestamp:C,message:m,type:w}])},K=async()=>{g("Testing API connection..."),A("Starting API health check","info");try{const m="/territory-api/health";g(`Testing: ${m}`),A(`Testing URL: ${m}`,"info");const w=performance.now(),C=await fetch(m,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)}),S=Math.round(performance.now()-w);if(A(`Response time: ${S}ms`,"success"),A(`Status: ${C.status} ${C.statusText}`,C.ok?"success":"error"),!C.ok)throw new Error(`HTTP ${C.status}: ${C.statusText}`);const Y=await C.json();g(`✅ API OK | URL: ${m} | Response: ${JSON.stringify(Y)}`),A(`API Response: ${JSON.stringify(Y)}`,"success")}catch(m){A(`Error: ${m.message}`,"error"),m.name==="TimeoutError"||m.message.includes("timeout")?g("❌ TIMEOUT | URL might be wrong or server down | Tried: /territory-api"):m.name==="TypeError"&&m.message.includes("fetch")?(g("❌ NETWORK ERROR | Can't reach server | Check if territory backend is running"),A("Network error - server unreachable","error")):g(`❌ API FAILED | Error: ${m.message} | Type: ${m.name}`)}},L=async m=>{var w,C,S,Y,V,B,G,te,h,T,x;m.preventDefault(),d(!0),y(""),g("Starting login..."),A(`Login attempt for: ${s}`,"info"),k(null);try{A("Login URL: /territory-api/auth/login","info"),g("Calling API...");const M=performance.now();await F(s,r);const b=Math.round(performance.now()-M);A(`Login successful in ${b}ms`,"success"),g("Login successful, redirecting..."),_("/dashboard")}catch(u){const M=((C=(w=u.response)==null?void 0:w.config)==null?void 0:C.responseTime)||"unknown",b=((Y=(S=u.response)==null?void 0:S.data)==null?void 0:Y.error)||u.message||"Login failed",Q=((V=u.response)==null?void 0:V.status)||"Unknown",oe=((B=u.response)==null?void 0:B.statusText)||"No status text",le="/territory-api",de=((te=(G=u.response)==null?void 0:G.config)==null?void 0:te.url)||"Unknown URL";y(b),k({message:b,status:Q,statusText:oe,url:de,responseTime:M,details:((h=u.response)==null?void 0:h.data)||{},timestamp:new Date().toISOString()}),A(`Login failed: ${b}`,"error"),A(`Status: ${Q} ${oe}`,"error"),A(`Response time: ${M}`,"error"),(T=u.response)!=null&&T.data&&A(`Server response: ${JSON.stringify(u.response.data)}`,"error"),g(`❌ LOGIN FAILED | Error: ${b} | Status: ${Q} | API: ${le}`),console.error("Login error details:",{error:u,response:u.response,message:u.message,stack:u.stack,config:(x=u.response)==null?void 0:x.config})}finally{d(!1)}};return e.jsxs("div",{className:"territory-auth-container",children:[e.jsx("div",{className:"territory-grid-bg"}),e.jsxs("div",{className:"territory-auth-overlay",children:[e.jsxs("div",{className:"territory-auth-form",children:[e.jsxs("div",{className:"territory-logo-section",children:[e.jsx("div",{className:"territory-logo",children:e.jsxs("div",{className:"logo-grid",children:[e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"})]})}),e.jsx("h1",{children:"Territory Conquest"}),e.jsx("p",{className:"territory-tagline",children:"Claim your domain. Expand your empire."})]}),c&&e.jsx("div",{className:"territory-error",children:c}),I&&e.jsx("div",{className:"territory-debug-info",children:I}),e.jsxs("form",{onSubmit:L,className:"territory-form",children:[e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"email",placeholder:"Email Address",value:s,onChange:m=>t(m.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"password",placeholder:"Password",value:r,onChange:m=>a(m.target.value),required:!0,className:"territory-input"})}),e.jsxs("button",{type:"submit",disabled:l,className:"territory-login-btn",children:[e.jsx("span",{className:"btn-grid-effect"}),l?"⚡ Connecting...":"🏁 Enter Battle"]})]}),e.jsx("div",{className:"territory-signup-link",children:e.jsxs("p",{children:["New commander? ",e.jsx(Te,{to:"/signup",className:"territory-link",children:"Join the conquest"})]})})]}),e.jsxs("div",{className:"territory-diagnostics-footer",children:[e.jsxs("button",{type:"button",className:"territory-diagnostics-toggle",onClick:()=>O(!D),children:[e.jsx("span",{children:"System Diagnostics"}),e.jsx("span",{className:`toggle-icon ${D?"open":""}`,children:"▼"})]}),D&&e.jsxs("div",{className:"territory-diagnostics-panel",children:[e.jsxs("div",{className:"territory-connection-info",children:[e.jsx("h4",{children:"System Information"}),e.jsxs("div",{className:"info-grid",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"API Endpoint:"})," ","/territory-api"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Host:"})," ",typeof window<"u"?window.location.host:"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Protocol:"})," ",typeof window<"u"?window.location.protocol:"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Environment:"})," Production"]})]})]}),e.jsxs("div",{className:"territory-diagnostic-tools",children:[e.jsx("h4",{children:"Diagnostic Tools"}),e.jsxs("div",{className:"territory-test-buttons",children:[e.jsx("button",{type:"button",className:"territory-btn-test api",onClick:K,children:"🔗 Test API Connection"}),e.jsx("button",{type:"button",className:"territory-btn-test direct",onClick:()=>window.open(`${window.location.origin}/territory-api/health`,"_blank"),children:"🚀 Direct API Test"}),e.jsx("button",{type:"button",className:"territory-btn-test clear",onClick:()=>{E([]),k(null),g("")},children:"🗑️ Clear Logs"})]})]}),v.length>0&&e.jsxs("div",{className:"territory-diagnostics-log",children:[e.jsx("h4",{children:"Network Activity Log"}),e.jsx("div",{className:"diagnostics-entries",children:v.map((m,w)=>e.jsxs("div",{className:`diagnostic-entry ${m.type}`,children:[e.jsx("span",{className:"diagnostic-time",children:m.timestamp}),e.jsx("span",{className:"diagnostic-message",children:m.message})]},w))})]}),N&&e.jsxs("div",{className:"territory-error-details",children:[e.jsx("h4",{children:"Last Error Details"}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Message:"})," ",N.message]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Status:"})," ",N.status," ",N.statusText]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"URL:"})," ",N.url]}),e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Time:"})," ",new Date(N.timestamp).toLocaleString()]}),Object.keys(N.details).length>0&&e.jsxs("div",{className:"error-detail-item",children:[e.jsx("strong",{children:"Response:"}),e.jsx("pre",{children:JSON.stringify(N.details,null,2)})]})]})]})]})]})]})},bs=()=>{const[s,t]=i.useState(""),[r,a]=i.useState(""),[l,d]=i.useState(""),[c,y]=i.useState(!1),[I,g]=i.useState(""),{signup:v}=ye(),E=we(),N=async k=>{var D,O;k.preventDefault(),y(!0),g("");try{await v(s,r,l),E("/dashboard")}catch(F){g(((O=(D=F.response)==null?void 0:D.data)==null?void 0:O.error)||"Signup failed")}finally{y(!1)}};return e.jsxs("div",{className:"territory-auth-container",children:[e.jsx("div",{className:"territory-grid-bg"}),e.jsx("div",{className:"territory-auth-overlay",children:e.jsxs("div",{className:"territory-auth-form",children:[e.jsxs("div",{className:"territory-logo-section",children:[e.jsx("div",{className:"territory-logo",children:e.jsxs("div",{className:"logo-grid",children:[e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell player2"})]})}),e.jsx("h1",{children:"Join the Conquest"}),e.jsx("p",{className:"territory-tagline",children:"Establish your command. Build your empire."})]}),I&&e.jsx("div",{className:"territory-error",children:I}),e.jsxs("form",{onSubmit:N,className:"territory-form",children:[e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"email",placeholder:"Email Address",value:s,onChange:k=>t(k.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"text",placeholder:"Commander Username",value:r,onChange:k=>a(k.target.value),required:!0,className:"territory-input"})}),e.jsx("div",{className:"territory-form-group",children:e.jsx("input",{type:"password",placeholder:"Password (minimum 6 characters)",value:l,onChange:k=>d(k.target.value),required:!0,minLength:6,className:"territory-input"})}),e.jsxs("button",{type:"submit",disabled:c,className:"territory-login-btn",children:[e.jsx("span",{className:"btn-grid-effect"}),c?"⚡ Establishing Command...":"🚀 Begin Conquest"]})]}),e.jsx("div",{className:"territory-signup-link",children:e.jsxs("p",{children:["Already a commander? ",e.jsx(Te,{to:"/login",className:"territory-link",children:"Enter the battle"})]})})]})})]})},ws=()=>{var te;const[s,t]=i.useState([]),[r,a]=i.useState(!0),[l,d]=i.useState(!1),[c,y]=i.useState(!1),[I,g]=i.useState({title:"",gameType:"territory",maxPlayers:8}),[v,E]=i.useState(null),[N,k]=i.useState(""),[D,O]=i.useState(!1),[F,_]=i.useState(null),[A,K]=i.useState(!1),{user:L,logout:m}=ye(),w=we();i.useEffect(()=>{C()},[]);const C=async()=>{var h;try{const T=await Ne.getGames();t(T.data)}catch(T){console.error("Failed to load games:",T),(h=T.response)==null||h.status}finally{a(!1)}},S=async h=>{var T,x;h.preventDefault(),d(!0);try{const u=await q.createGame(I.title);w(`/territory/${u.id}`),y(!1),g({title:"",gameType:"territory",maxPlayers:8})}catch(u){console.error("Failed to create game:",u),alert(`Failed to create game: ${((x=(T=u.response)==null?void 0:T.data)==null?void 0:x.error)||u.message}`)}finally{d(!1)}},Y=async(h,T)=>{var x,u;O(!0);try{await q.addPlayer(h,T),await C(),E(null),k("")}catch(M){console.error("Failed to add player:",M),alert(((u=(x=M.response)==null?void 0:x.data)==null?void 0:u.error)||"Failed to add player")}finally{O(!1)}},V=async h=>{var T,x;K(!0);try{await Ne.deleteGame(h),await C(),_(null)}catch(u){console.error("Failed to delete game:",u),alert(((x=(T=u.response)==null?void 0:T.data)==null?void 0:x.error)||"Failed to delete game")}finally{K(!1)}},B=h=>{var T;switch(h.status){case"WAITING":return`Waiting for players (${(T=h.players)==null?void 0:T.length}/${h.maxPlayers})`;case"ACTIVE":return"In progress";case"FINISHED":return"Finished";case"ABANDONED":return"Abandoned";default:return h.status}},G=h=>{switch(h){case"WAITING":return"status-waiting";case"ACTIVE":return"status-active";case"FINISHED":return"status-finished";case"ABANDONED":return"status-abandoned";default:return""}};return r?e.jsx("div",{className:"loading",children:"Loading games..."}):e.jsxs("div",{className:"territory-dashboard",children:[e.jsx("div",{className:"dashboard-bg-grid"}),e.jsxs("div",{className:"dashboard-overlay",children:[e.jsxs("header",{className:"territory-dashboard-header",children:[e.jsxs("div",{className:"dashboard-title-section",children:[e.jsx("div",{className:"dashboard-logo",children:e.jsxs("div",{className:"dashboard-logo-grid",children:[e.jsx("div",{className:"logo-cell active player1"}),e.jsx("div",{className:"logo-cell active player2"}),e.jsx("div",{className:"logo-cell active player3"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player1"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player2"}),e.jsx("div",{className:"logo-cell"}),e.jsx("div",{className:"logo-cell active player3"})]})}),e.jsxs("div",{className:"dashboard-title-text",children:[e.jsx("h1",{children:"Command Center"}),e.jsxs("p",{className:"welcome-commander",children:["Welcome back, Commander ",L==null?void 0:L.username,"!"]}),e.jsxs("div",{className:"status-indicator",children:[e.jsx("span",{className:"status-dot online"}),e.jsx("span",{className:"status-text",children:"Systems Online"})]})]})]}),e.jsxs("div",{className:"dashboard-actions",children:[e.jsxs("button",{onClick:()=>y(!0),className:"territory-btn-primary",children:[e.jsx("span",{className:"btn-icon",children:"⚔️"}),e.jsx("span",{children:"New Campaign"})]}),e.jsxs("button",{onClick:m,className:"territory-btn-logout",children:[e.jsx("span",{className:"btn-icon",children:"🚪"}),e.jsx("span",{children:"Logout"})]})]})]}),c&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"🗺️ Launch New Campaign"}),e.jsx("div",{className:"modal-subtitle",children:"Establish your territory and expand your dominion"})]}),e.jsxs("form",{onSubmit:S,className:"territory-create-form",children:[e.jsxs("div",{className:"territory-form-group",children:[e.jsxs("label",{className:"territory-label",children:[e.jsx("span",{className:"label-icon",children:"📝"}),e.jsx("span",{children:"Campaign Name"})]}),e.jsx("input",{type:"text",placeholder:"Enter campaign name...",value:I.title,onChange:h=>g({...I,title:h.target.value}),required:!0,className:"territory-input"})]}),e.jsxs("div",{className:"campaign-info",children:[e.jsxs("div",{className:"info-header",children:[e.jsx("span",{className:"info-icon",children:"⚔️"}),e.jsx("span",{className:"info-title",children:"Territory Conquest"})]}),e.jsxs("div",{className:"info-features",children:[e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"🏰"}),e.jsx("span",{children:"Real-time strategy gameplay"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"🎯"}),e.jsx("span",{children:"Enclosed area capture mechanics"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"👥"}),e.jsx("span",{children:"Up to 8 commanders"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"⚡"}),e.jsx("span",{children:"Move regeneration system"})]})]})]}),e.jsxs("div",{className:"territory-form-actions",children:[e.jsxs("button",{type:"button",onClick:()=>y(!1),className:"territory-btn-cancel",children:[e.jsx("span",{className:"btn-icon",children:"❌"}),e.jsx("span",{children:"Cancel"})]}),e.jsxs("button",{type:"submit",disabled:l,className:"territory-btn-create",children:[e.jsx("span",{className:"btn-icon",children:l?"⏳":"🚀"}),e.jsx("span",{children:l?"Launching...":"Launch Campaign"})]})]})]})]})}),e.jsxs("div",{className:"territory-games-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"🏰 Active Campaigns"}),e.jsxs("div",{className:"section-stats",children:[e.jsxs("span",{className:"stat-item",children:[e.jsx("span",{className:"stat-icon",children:"📊"}),e.jsxs("span",{className:"stat-text",children:[s.length," Total"]})]}),e.jsxs("span",{className:"stat-item",children:[e.jsx("span",{className:"stat-icon",children:"⚡"}),e.jsxs("span",{className:"stat-text",children:[s.filter(h=>h.status==="ACTIVE").length," Active"]})]})]})]}),s.length===0?e.jsxs("div",{className:"territory-empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:e.jsxs("div",{className:"empty-grid",children:[e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell center",children:"?"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"}),e.jsx("div",{className:"empty-cell"})]})}),e.jsx("h3",{children:"No Campaigns Found"}),e.jsx("p",{children:"Begin your conquest by creating your first territory campaign!"}),e.jsxs("button",{onClick:()=>y(!0),className:"territory-btn-primary",children:[e.jsx("span",{className:"btn-icon",children:"⚔️"}),e.jsx("span",{children:"Start First Campaign"})]})]}):e.jsx("div",{className:"territory-games-grid",children:s.map(h=>{var T,x,u;return e.jsxs("div",{className:"territory-game-card",children:[e.jsxs("div",{className:"game-card-header",children:[e.jsxs("div",{className:"game-title-section",children:[e.jsx("h3",{children:h.title}),e.jsxs("div",{className:"game-type-badge",children:[e.jsx("span",{className:"badge-icon",children:"🗺️"}),e.jsx("span",{children:"Territory"})]})]}),e.jsxs("div",{className:`territory-status ${G(h.status)}`,children:[e.jsx("span",{className:"status-icon",children:Cs(h.status)}),e.jsx("span",{className:"status-label",children:B(h)})]})]}),e.jsxs("div",{className:"game-preview",children:[e.jsx("div",{className:"preview-grid",children:Array.from({length:25},(M,b)=>e.jsx("div",{className:`preview-cell ${h.players&&h.players.length>0?b%3===0?"occupied p1":b%5===0?"occupied p2":"":""}`},b))}),e.jsx("div",{className:"preview-overlay",children:e.jsx("span",{className:"preview-text",children:"Campaign Preview"})})]}),e.jsxs("div",{className:"game-info",children:[e.jsxs("div",{className:"commander-info",children:[e.jsx("span",{className:"commander-label",children:"Commander:"}),e.jsx("span",{className:"commander-name",children:h.owner.username})]}),e.jsxs("div",{className:"players-roster",children:[e.jsx("span",{className:"roster-label",children:"Forces:"}),e.jsxs("div",{className:"player-indicators",children:[(T=h.players)==null?void 0:T.slice(0,3).map((M,b)=>e.jsx("div",{className:`player-badge p${b+1}`,children:M.user.username.charAt(0).toUpperCase()},M.id)),h.players&&h.players.length>3&&e.jsxs("div",{className:"player-badge more",children:["+",h.players.length-3]}),!h.players||h.players.length===0&&e.jsx("div",{className:"no-players",children:"Awaiting reinforcements"})]})]})]}),e.jsxs("div",{className:"territory-game-actions",children:[e.jsxs(Te,{to:`/${h.id}`,className:"territory-btn-play",children:[e.jsx("span",{className:"btn-icon",children:h.status==="FINISHED"?"👁️":"⚡"}),e.jsx("span",{children:h.status==="FINISHED"?"Inspect":"Deploy"})]}),h.ownerId===(L==null?void 0:L.id)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>E(h.id),className:"territory-btn-secondary",disabled:((x=h.players)==null?void 0:x.length)>=8,title:((u=h.players)==null?void 0:u.length)>=8?"Maximum 8 commanders":"Recruit commander",children:[e.jsx("span",{className:"btn-icon",children:"👥"}),e.jsx("span",{children:"Recruit"})]}),e.jsxs("button",{onClick:()=>_(h.id),className:"territory-btn-danger",title:"Abandon Campaign",children:[e.jsx("span",{className:"btn-icon",children:"💥"}),e.jsx("span",{children:"Abandon"})]})]})]})]},h.id)})})]})]}),v&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"👥 Recruit Commander"}),e.jsx("div",{className:"modal-subtitle",children:"Add a new commander to your campaign"})]}),e.jsxs("form",{onSubmit:h=>{h.preventDefault(),N.trim()&&Y(v,N.trim())},className:"territory-recruit-form",children:[e.jsxs("div",{className:"territory-form-group",children:[e.jsxs("label",{className:"territory-label",children:[e.jsx("span",{className:"label-icon",children:"🔍"}),e.jsx("span",{children:"Commander Identifier"})]}),e.jsx("input",{type:"text",placeholder:"Enter email or username...",value:N,onChange:h=>k(h.target.value),disabled:D,autoFocus:!0,className:"territory-input"})]}),e.jsx("div",{className:"recruit-info",children:e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-icon",children:"ℹ️"}),e.jsx("span",{children:"Commanders can immediately join and start conquering territory"})]})}),e.jsxs("div",{className:"territory-form-actions",children:[e.jsxs("button",{type:"button",onClick:()=>{E(null),k("")},className:"territory-btn-cancel",disabled:D,children:[e.jsx("span",{className:"btn-icon",children:"❌"}),e.jsx("span",{children:"Cancel"})]}),e.jsxs("button",{type:"submit",className:"territory-btn-create",disabled:!N.trim()||D,children:[e.jsx("span",{className:"btn-icon",children:D?"⏳":"👥"}),e.jsx("span",{children:D?"Recruiting...":"Recruit Commander"})]})]})]})]})}),F&&e.jsx("div",{className:"territory-modal",children:e.jsxs("div",{className:"territory-modal-content danger",children:[e.jsxs("div",{className:"modal-header danger",children:[e.jsx("h2",{children:"💥 Abandon Campaign"}),e.jsx("div",{className:"modal-subtitle",children:"This action will permanently destroy the campaign"})]}),e.jsxs("div",{className:"danger-warning",children:[e.jsx("div",{className:"warning-icon",children:"⚠️"}),e.jsxs("div",{className:"warning-content",children:[e.jsx("p",{children:e.jsx("strong",{children:"This cannot be undone!"})}),e.jsx("p",{children:"All territory progress, commander data, and battle history will be lost."}),e.jsxs("div",{className:"campaign-details",children:[e.jsx("span",{className:"detail-label",children:"Campaign:"}),e.jsx("span",{className:"detail-value",children:(te=s.find(h=>h.id===F))==null?void 0:te.title})]})]})]}),e.jsxs("div",{className:"territory-form-actions danger",children:[e.jsxs("button",{type:"button",onClick:()=>_(null),className:"territory-btn-cancel",disabled:A,children:[e.jsx("span",{className:"btn-icon",children:"🛡️"}),e.jsx("span",{children:"Keep Campaign"})]}),e.jsxs("button",{type:"button",onClick:()=>V(F),className:"territory-btn-danger-confirm",disabled:A,children:[e.jsx("span",{className:"btn-icon",children:A?"⏳":"💥"}),e.jsx("span",{children:A?"Abandoning...":"Abandon Campaign"})]})]})]})})]})},Cs=s=>{switch(s){case"WAITING":return"⏳";case"ACTIVE":return"⚡";case"FINISHED":return"🏆";case"ABANDONED":return"💀";default:return"❓"}},ks="/territory-ws";class Ss{constructor(){this.socket=null,this.gameId=null}connect(){return this.socket||(this.socket=We(ks,{withCredentials:!0}),this.socket.on("connect",()=>{console.log("Connected to socket server")}),this.socket.on("disconnect",()=>{console.log("Disconnected from socket server")})),this.socket}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.gameId=null)}joinGame(t){this.socket&&t!==this.gameId&&(this.gameId&&this.socket.emit("leave-game",this.gameId),this.gameId=t,this.socket.emit("join-game",t))}leaveGame(){this.socket&&this.gameId&&(this.socket.emit("leave-game",this.gameId),this.gameId=null)}emitMove(t,r){this.socket&&this.socket.emit("game-move",{gameId:t,moveData:r})}emitStateChange(t,r,a,l){this.socket&&this.socket.emit("game-state-change",{gameId:t,gameState:r,status:a,winnerId:l})}onMoveMade(t){this.socket&&this.socket.on("move-made",t)}onStateUpdated(t){this.socket&&this.socket.on("state-updated",t)}offMoveMade(t){this.socket&&this.socket.off("move-made",t)}offStateUpdated(t){this.socket&&this.socket.off("state-updated",t)}}const ne=new Ss,Ts=()=>{var O,F,_,A,K,L;const{id:s}=_e(),t=we(),{user:r}=ye(),[a,l]=i.useState(null),[d,c]=i.useState(!0),[y,I]=i.useState(""),g=i.useCallback(async()=>{var m,w,C;try{console.log("🎮 Loading game:",s,"for user:",r==null?void 0:r.username);const S=await Ne.getGame(s);console.log("✅ Game loaded successfully:",S.data.title),l(S.data)}catch(S){console.error("❌ Failed to load game:",S),console.error("Error details:",{status:(m=S.response)==null?void 0:m.status,data:(w=S.response)==null?void 0:w.data,gameId:s,user:r==null?void 0:r.username}),((C=S.response)==null?void 0:C.status)===404&&(console.log("🚪 Game not found, redirecting to dashboard"),t("/dashboard"))}finally{c(!1)}},[s,t,r]);i.useEffect(()=>{g()},[g]),i.useEffect(()=>{if(a){ne.connect(),ne.joinGame(a.id);const m=C=>{console.log("Move made:",C),g()},w=C=>{console.log("State updated:",C),g()};return ne.onMoveMade(m),ne.onStateUpdated(w),()=>{ne.offMoveMade(m),ne.offStateUpdated(w),ne.leaveGame()}}},[a,g]);const v=async m=>{var w,C;if(m.preventDefault(),!!y.trim())try{const S={action:y.trim(),timestamp:Date.now()};await Ne.makeMove(s,S),ne.emitMove(s,S),I(""),g()}catch(S){console.error("Failed to make move:",S),alert(((C=(w=S.response)==null?void 0:w.data)==null?void 0:C.error)||"Failed to make move")}},E=async()=>{var m,w;try{await Ne.joinGame(s),g()}catch(C){console.error("Failed to join game:",C),alert(((w=(m=C.response)==null?void 0:m.data)==null?void 0:w.error)||"Failed to join game")}};if(d)return e.jsx("div",{className:"loading",children:"Loading game..."});if(!a)return e.jsx("div",{className:"error",children:"Game not found"});const N=(O=a.players)==null?void 0:O.some(m=>m.userId===(r==null?void 0:r.id));a.ownerId,r==null||r.id;const k=a.currentTurn===(r==null?void 0:r.id),D=(F=a.players)==null?void 0:F.find(m=>m.userId===a.currentTurn);return e.jsxs("div",{className:"game-room",children:[e.jsx("header",{className:"game-header",children:e.jsxs("div",{children:[e.jsx(Te,{to:"/dashboard",className:"back-link",children:"← Back to Dashboard"}),e.jsx("h1",{children:a.title}),e.jsxs("div",{className:"game-meta",children:[e.jsx("span",{className:"game-type",children:a.gameType}),e.jsx("span",{className:`status status-${a.status.toLowerCase()}`,children:a.status})]})]})}),e.jsxs("div",{className:"game-content",children:[e.jsxs("div",{className:"game-sidebar",children:[e.jsxs("div",{className:"players-section",children:[e.jsxs("h3",{children:["Players (",(_=a.players)==null?void 0:_.length,"/",a.maxPlayers,")"]}),e.jsx("div",{className:"players-list",children:(A=a.players)==null?void 0:A.map(m=>e.jsxs("div",{className:`player ${m.userId===a.currentTurn?"current-turn":""}`,children:[e.jsx("span",{className:"player-name",children:m.user.username}),m.userId===a.ownerId&&e.jsx("span",{className:"owner-badge",children:"Owner"}),m.userId===a.currentTurn&&e.jsx("span",{className:"turn-indicator",children:"Current Turn"})]},m.id))}),!N&&a.status==="WAITING"&&e.jsx("button",{onClick:E,className:"btn-primary",children:"Join Game"})]}),a.moves&&a.moves.length>0&&e.jsxs("div",{className:"moves-section",children:[e.jsx("h3",{children:"Game Log"}),e.jsx("div",{className:"moves-list",children:a.moves.map(m=>{var w;return e.jsxs("div",{className:"move",children:[e.jsxs("span",{className:"move-player",children:[(w=m.user)==null?void 0:w.username,":"]}),e.jsx("span",{className:"move-data",children:typeof m.moveData=="string"?m.moveData:JSON.stringify(m.moveData)})]},m.id)})})]})]}),e.jsx("div",{className:"game-main",children:e.jsxs("div",{className:"game-board",children:[a.status==="WAITING"&&e.jsxs("div",{className:"waiting-message",children:[e.jsx("h2",{children:"Waiting for players..."}),e.jsx("p",{children:"Share this URL with friends to invite them to play!"})]}),a.status==="ACTIVE"&&e.jsxs("div",{className:"game-active",children:[e.jsx("div",{className:"turn-indicator",children:k?e.jsx("h3",{children:"Your turn!"}):e.jsxs("h3",{children:["Waiting for ",D==null?void 0:D.user.username,"'s move..."]})}),a.gameState&&e.jsxs("div",{className:"game-state",children:[e.jsx("h4",{children:"Game State:"}),e.jsx("pre",{children:typeof a.gameState=="string"?a.gameState:JSON.stringify(a.gameState,null,2)})]}),N&&k&&e.jsx("div",{className:"move-input",children:e.jsxs("form",{onSubmit:v,children:[e.jsx("input",{type:"text",placeholder:"Enter your move...",value:y,onChange:m=>I(m.target.value),disabled:!k}),e.jsx("button",{type:"submit",disabled:!y.trim(),children:"Make Move"})]})})]}),a.status==="FINISHED"&&e.jsxs("div",{className:"game-finished",children:[e.jsx("h2",{children:"Game Over!"}),a.winnerId&&e.jsxs("p",{children:["Winner: ",(L=(K=a.players)==null?void 0:K.find(m=>m.userId===a.winnerId))==null?void 0:L.user.username]})]}),a.status==="ABANDONED"&&e.jsxs("div",{className:"game-abandoned",children:[e.jsx("h2",{children:"Game Abandoned"}),e.jsx("p",{children:"This game was abandoned by the players."})]})]})})]})]})},Es="/territory-ws";function Ke(){const[s,t]=i.useState(null);return i.useEffect(()=>{const r=We(Es,{withCredentials:!0,transports:["websocket","polling"]});return r.on("connect",()=>{console.log("Socket connected:",r.id)}),r.on("disconnect",()=>{console.log("Socket disconnected")}),r.on("error",a=>{console.error("Socket error:",a)}),t(r),()=>{r.close()}},[]),s}const J=20,Se=64,As=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8","#FF8A80","#80CBC4","#90CAF9","#C8E6C9","#FFF59D","#E1BEE7","#FFCC80","#B2DFDB"],Qe=i.forwardRef(({gameId:s,playerColor:t,onMoveComplete:r,initialCenter:a},l)=>{const d=i.useRef(null),[c,y]=i.useState({x:(a==null?void 0:a.x)||0,y:(a==null?void 0:a.y)||0,zoom:1}),[I,g]=i.useState(new Map),[v,E]=i.useState(!1),[N,k]=i.useState({x:0,y:0}),[D,O]=i.useState(null),[F,_]=i.useState(new Set),[A,K]=i.useState(0),[L,m]=i.useState(null),[w,C]=i.useState(null),[S,Y]=i.useState(new Map),[V,B]=i.useState(null),G=Ke(),{theme:te}=Le(),h=i.useCallback(({x:n,y:o})=>{const p=d.current;if(!p)return{x:0,y:0};const f=p.width/2,j=p.height/2;return{x:f+(n-c.x)*J*c.zoom,y:j+(o-c.y)*J*c.zoom}},[c]),T=i.useCallback(({x:n,y:o})=>{const p=d.current;if(!p)return{x:0,y:0};const f=p.width/2,j=p.height/2;return{x:Math.floor((n-f)/(J*c.zoom)+c.x),y:Math.floor((o-j)/(J*c.zoom)+c.y)}},[c]),x=i.useCallback((n,o)=>{const p=n.clientX-o.clientX,f=n.clientY-o.clientY;return Math.sqrt(p*p+f*f)},[]),u=i.useCallback((n,o)=>{var f;const p=(f=d.current)==null?void 0:f.getBoundingClientRect();return p?{x:(n.clientX+o.clientX)/2-p.left,y:(n.clientY+o.clientY)/2-p.top}:{x:0,y:0}},[]),M=i.useCallback(async()=>{const n=d.current;if(!n)return;const o=Math.ceil(Math.max(n.width,n.height)/(J*c.zoom))+2,p=Math.floor(o/2),f={minX:Math.floor(c.x-p),maxX:Math.ceil(c.x+p),minY:Math.floor(c.y-p),maxY:Math.ceil(c.y+p)};try{const j=await q.getRegion(s,f),P=new Map(I);for(const $ in j.cells)for(const U in j.cells[$]){const H=`${$},${U}`;P.set(H,j.cells[$][U])}g(P);const R=new Set;for(let $=f.minX;$<=f.maxX;$+=Se)for(let U=f.minY;U<=f.maxY;U+=Se){const H=Math.floor($/Se),X=Math.floor(U/Se),ee=`${H},${X}`;R.add(ee),F.has(ee)||G==null||G.emit("subscribe-chunk",{gameId:s,chunkId:ee})}F.forEach($=>{R.has($)||G==null||G.emit("unsubscribe-chunk",{gameId:s,chunkId:$})}),_(R)}catch(j){console.error("Failed to fetch region:",j)}},[s,c,I,F,G]);i.useImperativeHandle(l,()=>({forceRefresh:()=>{M()},centerView:()=>{y(n=>({...n,x:0,y:0}))},zoomIn:()=>{y(n=>({...n,zoom:Math.min(5,n.zoom*1.5)}))},zoomOut:()=>{y(n=>({...n,zoom:Math.max(.1,n.zoom/1.5)}))}}),[M]);const b=i.useCallback(()=>{const n=d.current,o=n==null?void 0:n.getContext("2d");if(!n||!o)return;o.clearRect(0,0,n.width,n.height);const p=getComputedStyle(document.documentElement),f=p.getPropertyValue("--bg").trim(),j=p.getPropertyValue("--grid").trim();if(o.fillStyle=f,o.fillRect(0,0,n.width,n.height),c.zoom>=.5){o.strokeStyle=j,o.globalAlpha=Math.min(1,(c.zoom-.3)/.7),o.lineWidth=1;const U=Math.ceil(Math.max(n.width,n.height)/(J*c.zoom))+2,H=Math.floor(U/2);for(let X=-H;X<=H;X++){const ee=Math.floor(c.x+X),ae=h({x:ee,y:c.y});o.beginPath(),o.moveTo(ae.x,0),o.lineTo(ae.x,n.height),o.stroke()}for(let X=-H;X<=H;X++){const ee=Math.floor(c.y+X),ae=h({x:c.x,y:ee});o.beginPath(),o.moveTo(0,ae.y),o.lineTo(n.width,ae.y),o.stroke()}o.globalAlpha=1}const R=Math.ceil(Math.max(n.width,n.height)/(J*c.zoom))+2,$=Math.floor(R/2);for(let U=-$;U<=$;U++)for(let H=-$;H<=$;H++){const X=Math.floor(c.x+U),ee=Math.floor(c.y+H),ae=`${X},${ee}`,De=I.get(ae),ue=h({x:X,y:ee}),he=J*c.zoom,pe=S.get(ae);let je=1,Be=1;if(pe){const ge=Date.now()-pe.startTime-(pe.delay||0),ve=pe.type==="place"?250:200;if(ge>=0&&ge<ve){const Me=Math.min(ge/ve,1);pe.type==="place"?(je=.1+.9*Me,Be=Me):pe.type==="flip"&&(je=1+.3*Math.sin(Me*Math.PI))}}if(De!=null){if(o.save(),o.globalAlpha=Be,je!==1){const ge=ue.x+he/2,ve=ue.y+he/2;o.translate(ge,ve),o.scale(je,je),o.translate(-ge,-ve)}o.fillStyle=As[De]||"#333",o.fillRect(ue.x,ue.y,he-1,he-1),o.restore()}D&&D.x===X&&D.y===ee&&(o.strokeStyle="#fff",o.lineWidth=2,o.strokeRect(ue.x,ue.y,he-1,he-1),o.lineWidth=1)}o.fillStyle="#fff",o.font="14px monospace",o.fillText(`Position: ${Math.floor(c.x)}, ${Math.floor(c.y)}`,10,20),o.fillText(`Zoom: ${c.zoom.toFixed(2)}x`,10,40)},[c,I,D,h,S,te]);i.useEffect(()=>{M()},[M]),i.useEffect(()=>{a&&(a.x!==c.x||a.y!==c.y)&&(console.log("Centering map on player's first cell:",a),y(n=>({...n,x:a.x,y:a.y})))},[a]),i.useEffect(()=>{const n=()=>{const o=Date.now(),p=new Map;if(S.forEach((f,j)=>{const P=o-f.startTime-(f.delay||0),R=f.type==="place"?250:200;P<R&&p.set(j,f)}),p.size!==S.size&&Y(p),p.size>0){const f=requestAnimationFrame(n);B(f)}else B(null)};if(S.size>0&&!V){const o=requestAnimationFrame(n);B(o)}return()=>{V&&cancelAnimationFrame(V)}},[S,V]);const Q=i.useCallback(n=>{Y(o=>new Map(o).set(n,{type:"place",startTime:Date.now(),delay:0}))},[]),oe=i.useCallback((n,o)=>{const p=Date.now();Y(f=>{const j=new Map(f);return n.forEach((P,R)=>{if(P!==o){const $=Math.min(R*80,1e3);j.set(P,{type:"flip",startTime:p,delay:$})}}),j})},[]);i.useEffect(()=>{const n=d.current;if(!n)return;const o=()=>{n.width=n.offsetWidth,n.height=n.offsetHeight,b()};return o(),window.addEventListener("resize",o),()=>{window.removeEventListener("resize",o)}},[b]),i.useEffect(()=>{b()},[b]),i.useEffect(()=>{if(!G)return;const n=o=>{if(!o.changes)return;const p=new Map(I);o.changes.forEach(f=>{const j=`${f.x},${f.y}`;p.set(j,f.ownerColour)}),g(p)};return G.on("update",n),()=>{G.off("update",n)}},[G,I]);const le=n=>{d.current.getBoundingClientRect(),n.button===0&&(E(!0),k({x:n.clientX,y:n.clientY}))},de=n=>{const o=d.current.getBoundingClientRect(),p=n.clientX-o.left,f=n.clientY-o.top;if(v){const j=(n.clientX-N.x)/(J*c.zoom),P=(n.clientY-N.y)/(J*c.zoom);y(R=>({...R,x:R.x-j,y:R.y-P})),k({x:n.clientX,y:n.clientY})}else{const j=T({x:p,y:f});O(j)}},re=()=>{E(!1)},ie=n=>{n.preventDefault();const o=n.deltaY>0?.9:1.1;y(p=>({...p,zoom:Math.max(.1,Math.min(5,p.zoom*o))}))},Ce=async n=>{if(v)return;const o=d.current.getBoundingClientRect(),p=n.clientX-o.left,f=n.clientY-o.top,j=T({x:p,y:f});await Ge(j.x,j.y)};i.useEffect(()=>{const n=d.current;n&&(n.zoomIn=()=>{y(o=>({...o,zoom:Math.min(5,o.zoom*1.2)}))},n.zoomOut=()=>{y(o=>({...o,zoom:Math.max(.1,o.zoom/1.2)}))},n.centerView=()=>{y({x:0,y:0,zoom:1})})},[]);const me=n=>{if(n.touches.length===2){n.preventDefault(),E(!1),m(null);const o=n.touches[0],p=n.touches[1],f=x(o,p),j=u(o,p),P=T(j);C({initialDistance:f,initialZoom:c.zoom,center:P});return}if(n.touches.length===1){n.preventDefault();const o=n.touches[0],p=d.current.getBoundingClientRect(),f=o.clientX-p.left,j=o.clientY-p.top;m({x:f,y:j}),E(!0),k({x:o.clientX,y:o.clientY});const P=Date.now();if(P-A<300){const R=T({x:f,y:j});y($=>({x:R.x,y:R.y,zoom:Math.min(5,$.zoom*1.5)}))}K(P)}},ss=n=>{if(n.touches.length===2&&w){n.preventDefault();const o=n.touches[0],p=n.touches[1],f=x(o,p),j=u(o,p),P=f/w.initialDistance,R=Math.max(.1,Math.min(5,w.initialZoom*P));T(j);const $=R/c.zoom;y(U=>({x:w.center.x+(U.x-w.center.x)/$,y:w.center.y+(U.y-w.center.y)/$,zoom:R}));return}if(n.touches.length===1&&v&&L){n.preventDefault();const o=n.touches[0],p=(o.clientX-N.x)/(J*c.zoom),f=(o.clientY-N.y)/(J*c.zoom);y(j=>({...j,x:j.x-p,y:j.y-f})),k({x:o.clientX,y:o.clientY})}},ts=n=>{if(n.touches.length===0){if(n.preventDefault(),C(null),!L){E(!1);return}const o=n.changedTouches[0],p=d.current.getBoundingClientRect(),f=o.clientX-p.left,j=o.clientY-p.top;if(Math.sqrt(Math.pow(f-L.x,2)+Math.pow(j-L.y,2))<10&&v){const R=T({x:f,y:j});Ge(R.x,R.y)}E(!1),m(null)}else if(n.touches.length===1&&w){C(null);const o=n.touches[0],p=d.current.getBoundingClientRect(),f=o.clientX-p.left,j=o.clientY-p.top;m({x:f,y:j}),E(!0),k({x:o.clientX,y:o.clientY})}},Ge=async(n,o)=>{const p=`${n},${o}`;try{Q(p);const f=await q.makeMove(s,n,o);f!=null&&f.captured&&f.captured.length>1&&oe(f.captured,p),r&&r(f)}catch(f){console.error("Failed to make move:",f),Y(j=>{const P=new Map(j);return P.delete(p),P})}};return e.jsxs("div",{style:{position:"relative",width:"100%",height:"100%"},children:[e.jsx("canvas",{ref:d,className:"territory-canvas",style:{width:"100%",height:"100%",cursor:v?"grabbing":"crosshair",imageRendering:"pixelated"},onMouseDown:le,onMouseMove:de,onMouseUp:re,onMouseLeave:re,onWheel:ie,onClick:Ce,onTouchStart:me,onTouchMove:ss,onTouchEnd:ts,onContextMenu:n=>n.preventDefault()}),e.jsxs("div",{style:{position:"absolute",top:10,left:10,background:"rgba(0,0,0,0.8)",color:"white",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontFamily:"monospace",pointerEvents:"none"},children:["Position: ",Math.floor(c.x),", ",Math.floor(c.y),e.jsx("br",{}),"Zoom: ",c.zoom.toFixed(2),"x",e.jsx("br",{}),D&&`Target: (${D.x}, ${D.y})`]})]})});Qe.displayName="TerritoryGrid";let Ds=0;const be=[];let ce=null;const fe=(s,t="info",r=3e3)=>{const a={id:++Ds,message:s,type:t,duration:r};ce?(ce(l=>[...l,a]),setTimeout(()=>{es(a.id)},r)):be.length<10&&be.push(a)},es=s=>{ce&&(ce(t=>t.map(r=>r.id===s?{...r,removing:!0}:r)),setTimeout(()=>{ce(t=>t.filter(r=>r.id!==s))},300))};function Oe(){const[s,t]=i.useState([]);return i.useEffect(()=>{if(ce=t,be.length>0){const r=be.splice(0);t(r),r.forEach(a=>{setTimeout(()=>{es(a.id)},a.duration)})}return()=>{ce=null,t([]),be.length=0}},[]),e.jsx("div",{className:"toast-container",children:s.map(r=>e.jsx("div",{className:`toast ${r.type} ${r.removing?"removing":""}`,children:r.message},r.id))})}function Ms({current:s,max:t,nextRegenAt:r,currentTime:a}){const l=s/t*100,d=()=>{if(!r||s>=t)return"";const c=Math.max(0,new Date(r)-a),y=Math.ceil(c/1e3);return y<=0?"Regenerating...":`+1 in ${y}s`};return e.jsxs("div",{className:"moves-bar",children:[e.jsx("div",{className:"moves-progress",children:e.jsx("div",{className:"moves-fill",style:{width:`${l}%`}})}),e.jsxs("div",{className:"moves-text",children:[s,"/",t]}),r&&s<t&&e.jsx("div",{className:"moves-regen",style:{fontSize:"10px",color:"var(--text-dim)",marginLeft:"8px"},children:d()})]})}const Is=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8"];function Rs({scoreboard:s,currentPlayerColor:t,lastActivePlayer:r}){const a=l=>l.split(" ").map(d=>d[0]).join("").toUpperCase().slice(0,2);return e.jsxs("div",{className:"enhanced-scoreboard",children:[e.jsx("h4",{style:{color:"var(--text)",marginBottom:"12px",fontSize:"14px"},children:"Players"}),s.map(l=>{const d=l.colour===t,c=l.colour===r;return e.jsxs("div",{className:`scoreboard-row ${d?"current-player":""} ${c?"player-acting":""}`,children:[e.jsx("div",{className:"player-swatch",style:{backgroundColor:Is[l.colour]||"#666",border:d?"2px solid var(--accent)":"1px solid var(--grid)"}}),e.jsxs("div",{className:"player-name",children:[d&&"★ ",a(l.username),d&&" (You)"]}),e.jsx("div",{className:"player-score",children:l.count||0})]},l.colour)})]})}const Ue=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8","#FF8A80","#80CBC4","#90CAF9","#C8E6C9","#FFF59D","#E1BEE7","#FFCC80","#B2DFDB"],Ye=["Red","Teal","Blue","Green","Yellow","Purple","Orange","Mint","Light Red","Light Teal","Light Blue","Light Green","Light Yellow","Light Purple","Light Orange","Light Cyan"];function $s({gameId:s,currentColor:t,usedColors:r=[],onColorSelect:a,onClose:l,isVisible:d}){const[c,y]=i.useState(!1);if(!d)return null;const I=async g=>{if(!(r.includes(g)&&g!==t)){y(!0);try{await a(g),l()}catch(v){console.error("Failed to select color:",v)}finally{y(!1)}}};return e.jsx("div",{className:"color-picker-overlay",onClick:l,children:e.jsxs("div",{className:"color-picker-modal",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"color-picker-header",children:[e.jsx("h3",{children:"Select Your Color"}),e.jsx("button",{className:"close-button",onClick:l,disabled:c,children:"×"})]}),e.jsxs("div",{className:"color-picker-note",children:[t!==null&&e.jsxs("p",{children:["Current: ",e.jsx("span",{style:{color:Ue[t]},children:Ye[t]})]}),e.jsx("p",{className:"color-picker-info",children:"Select a new color to instantly update all your territory!"})]}),e.jsx("div",{className:"color-picker-grid",children:Ue.map((g,v)=>{const E=r.includes(v)&&v!==t,N=v===t;return e.jsxs("button",{className:`color-option ${N?"current":""} ${E?"used":""}`,style:{backgroundColor:g},onClick:()=>I(v),disabled:c||E,title:`${Ye[v]}${E?" (taken)":""}${N?" (current)":""}`,children:[N&&e.jsx("span",{className:"checkmark",children:"✓"}),E&&e.jsx("span",{className:"lock",children:"🔒"})]},v)})}),e.jsx("div",{className:"color-picker-actions",children:e.jsx("button",{className:"cancel-button",onClick:l,disabled:c,children:"Cancel"})})]})})}function Ps(){const{gameId:s}=_e(),t=we(),{user:r}=ye(),a=Ke(),{toggleTheme:l,isDark:d}=Le(),c=i.useRef(null),[y,I]=i.useState(null),[g,v]=i.useState(null),[E,N]=i.useState(0),[k,D]=i.useState(null),[O,F]=i.useState([]),[_,A]=i.useState(null),[K,L]=i.useState(new Date),[m,w]=i.useState(!1),[C,S]=i.useState(!1),[Y,V]=i.useState(!1);i.useEffect(()=>(document.body.classList.add("territory-mode"),()=>{document.body.classList.remove("territory-mode")}),[]);const B=i.useCallback(async(x=0)=>{var u,M;if(!(!s||!r))try{const b=await q.getAvailableMoves(s);N(b.availableMoves||0),D(b.nextRegenAt)}catch(b){if(((u=b.response)==null?void 0:u.status)===401&&x<3){setTimeout(()=>B(x+1),(x+1)*500);return}((M=b.response)==null?void 0:M.status)===401&&(N(0),D(null))}},[s,r]),G=i.useCallback(async x=>{await B(),x!=null&&x.captured&&x.captured>1?fe(`Chain capture x${x.captured}!`,"success"):fe("Territory claimed!","info")},[B]),te=i.useCallback(()=>{c.current&&c.current.centerView&&c.current.centerView()},[]),h=i.useCallback(async()=>{if(!(!s||!r))try{const x=await q.getScoreboard(s);F(x)}catch(x){console.error("Failed to refresh scoreboard:",x)}},[s,r]),T=i.useCallback(async x=>{var u,M;try{const b=await q.selectColor(s,x);v(Q=>Q?{...Q,colour:x}:null),b.cellsUpdated>0?fe(`Color changed! ${b.cellsUpdated} cells updated.`,"success"):fe("Color changed successfully!","success"),c.current&&c.current.forceRefresh&&c.current.forceRefresh(),await B(),await h()}catch(b){throw console.error("Failed to select color:",b),fe(((M=(u=b.response)==null?void 0:u.data)==null?void 0:M.error)||"Failed to change color","error"),b}},[s,B,h]);return i.useEffect(()=>{if(!s||!r)return;v(null),N(0),D(null),F([]),A(null);const x=new AbortController;let u=!0;return(async()=>{var b,Q,oe,le,de;if(!C)try{S(!0);const re=await q.joinGame(s);if(!u)return;v(re);const ie=a;ie&&u&&ie.emit("join-game",s)}catch(re){if(((b=re.response)==null?void 0:b.status)===400&&((oe=(Q=re.response)==null?void 0:Q.data)==null?void 0:oe.error)==="Already joined this game")try{const ie=await q.getScoreboard(s);if(!u)return;const Ce=ie.find(me=>me.username===(r==null?void 0:r.username));if(Ce){v({colour:Ce.colour});const me=a;me&&u&&me.emit("join-game",s)}else u&&A("Could not determine player info")}catch{u&&A("Game not found or inaccessible")}else u&&A(((de=(le=re.response)==null?void 0:le.data)==null?void 0:de.error)||"Failed to join game")}finally{S(!1)}})(),()=>{u=!1,x.abort()}},[s,r]),i.useEffect(()=>{const x=M=>{a&&s&&a.emit("leave-game",s)},u=()=>{document.visibilityState==="visible"&&a&&s&&a.emit("join-game",s)};return window.addEventListener("beforeunload",x),document.addEventListener("visibilitychange",u),()=>{window.removeEventListener("beforeunload",x),document.removeEventListener("visibilitychange",u)}},[a,s]),i.useEffect(()=>{if(a&&s&&g){const x=()=>{a.emit("join-game",s)};return a.on("connect",x),()=>{a.off("connect",x)}}},[a,s,g]),i.useEffect(()=>{if(s&&g&&r){const x=setTimeout(()=>{B()},100),u=setInterval(B,5e3);return()=>{clearTimeout(x),clearInterval(u)}}},[s,g,r,B]),i.useEffect(()=>{const x=async()=>{if(r)try{const u=await q.getScoreboard(s);F(u)}catch(u){console.error("Failed to fetch scoreboard:",u)}};if(s&&r){x();const u=setInterval(x,1e4);return()=>{clearInterval(u)}}},[s,r]),i.useEffect(()=>{if(!a)return;const x=u=>{if(u.scores){const M=u.scores.map(b=>({colour:b.colour,count:b.count,username:b.username||`Player ${b.colour}`}));F(M)}u.type==="color-changed"&&(h(),c.current&&c.current.forceRefresh&&c.current.forceRefresh(),u.playerId!==(r==null?void 0:r.id)&&fe(`A player changed their color (${u.cellsUpdated} cells updated)`,"info"))};return a.on("update",x),()=>{a.off("update",x)}},[a,r,h]),i.useEffect(()=>{const x=setInterval(()=>{L(new Date)},1e3);return()=>clearInterval(x)},[]),_?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",background:"#1a1a1a",color:"white"},children:[e.jsx("h2",{children:"Territory Game Error"}),e.jsx("p",{children:_}),e.jsx("button",{onClick:()=>t("/dashboard"),style:{marginTop:"20px",padding:"10px 20px",background:"#4ECDC4",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Back to Dashboard"})]}):e.jsxs("div",{className:"territory-game-container",children:[e.jsxs("div",{className:"floating-game-info",children:[e.jsx("button",{className:"game-info-toggle",onClick:()=>w(!m),children:e.jsxs("div",{className:"burger-icon",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),m&&e.jsxs("div",{className:"game-info-panel",children:[e.jsxs("div",{className:"game-info-header",children:[e.jsx("h4",{children:"Game Info"}),g&&e.jsxs("div",{className:"player-info-compact",children:[e.jsx("div",{className:"player-color-indicator-small",style:{background:g.colour!==void 0?["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#F4A460","#98D8C8","#FF8A80","#80CBC4","#90CAF9","#C8E6C9","#FFF59D","#E1BEE7","#FFCC80","#B2DFDB"][g.colour]:"#666"}}),e.jsxs("span",{children:["#",g.colour]})]})]}),e.jsx(Rs,{scoreboard:O,currentPlayerColor:g==null?void 0:g.colour}),e.jsxs("div",{className:"game-info-actions",children:[e.jsx("button",{onClick:()=>V(!0),className:"compact-theme-button",title:"Select your color",children:"🎨 Color"}),e.jsxs("button",{onClick:l,className:"compact-theme-button",title:`Switch to ${d?"light":"dark"} mode`,children:[d?"☀️":"🌙"," ",d?"Light":"Dark"]}),e.jsx("button",{onClick:()=>t("/dashboard"),className:"compact-leave-button",children:"Leave Game"})]})]})]}),e.jsxs("div",{className:"territory-main-area",children:[e.jsx("div",{className:"territory-canvas-container",children:e.jsx(Qe,{ref:c,gameId:s,playerColor:g==null?void 0:g.colour,onMoveComplete:G,initialCenter:g==null?void 0:g.firstCell})}),e.jsx(Oe,{}),e.jsxs("div",{className:"mobile-toolbar",children:[e.jsx("button",{className:"toolbar-button",onClick:te,title:"Center View",children:"⌖"}),e.jsx("div",{className:"toolbar-moves",children:e.jsx(Ms,{current:E,max:25,nextRegenAt:k,currentTime:K})}),e.jsxs("div",{className:"toolbar-zoom",children:[e.jsx("button",{className:"toolbar-button",onTouchStart:x=>{x.preventDefault(),c.current&&c.current.zoomOut&&c.current.zoomOut()},title:"Zoom Out",children:"−"}),e.jsx("button",{className:"toolbar-button",onTouchStart:x=>{x.preventDefault(),c.current&&c.current.zoomIn&&c.current.zoomIn()},title:"Zoom In",children:"+"})]})]})]}),e.jsx($s,{gameId:s,currentColor:g==null?void 0:g.colour,usedColors:O.map(x=>x.colour),onColorSelect:T,onClose:()=>V(!1),isVisible:Y}),e.jsx(Oe,{})]})}function Fs(){const{theme:s,toggleTheme:t,isDark:r}=Le();return e.jsx("button",{className:"theme-toggle",onClick:t,title:`Switch to ${r?"light":"dark"} mode`,"aria-label":`Switch to ${r?"light":"dark"} mode`,children:r?"☀️":"🌙"})}function Ls(){return e.jsx(vs,{children:e.jsx(js,{children:e.jsx(as,{basename:"/territory",children:e.jsxs("div",{className:"app",children:[e.jsx(Fs,{}),e.jsxs(ns,{children:[e.jsx(xe,{path:"/",element:e.jsx(qe,{to:"/dashboard",replace:!0})}),e.jsx(xe,{path:"/login",element:e.jsx(Ns,{})}),e.jsx(xe,{path:"/signup",element:e.jsx(bs,{})}),e.jsx(xe,{path:"/dashboard",element:e.jsx($e,{children:e.jsx(ws,{})})}),e.jsx(xe,{path:"/game/:id",element:e.jsx($e,{children:e.jsx(Ts,{})})}),e.jsx(xe,{path:"/:gameId",element:e.jsx($e,{children:e.jsx(Ps,{})})})]})]})})})})}Pe.createRoot(document.getElementById("root")).render(e.jsx(os.StrictMode,{children:e.jsx(Ls,{})}));
